<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ระบบติดตามน้ำมันโลจิสติกส์</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0284c7', // sky-600
                        'secondary': '#0369a1', // sky-700
                        'accent': '#f97316', // orange-500
                        'neutral': '#374151', // gray-700
                        'base-100': '#1f2937', // gray-800
                        'info': '#0ea5e9', // sky-500
                        'success': '#22c55e', // green-500
                        'warning': '#eab308', // yellow-500
                        'error': '#ef4444', // red-500
                    }
                }
            }
        }
    </script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <!-- XLSX for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-base-100 text-gray-300 font-sans text-base">
    <div id="app-container">
        <!-- App will be rendered here -->
    </div>

    <script>
        // --- START OF SCRIPT ---

        // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        // 1. CONSTANTS & CONFIGURATION
        // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        
        const GAS_STATION_KEYS = [
            'nissan_singburi',
            'jittamas_bangpain',
            'srinakorn_klongklung',
            'daopaisan_nakhonsawan',
            'ekawitat_nonthaburi',
            'daourai_sai3',
            'tekyong_chonburi',
            'rungpattana_wangnoi',
        ];

        const GAS_STATION_FRIENDLY_NAMES = {
            'nissan_singburi': 'นิสสัน (สิงห์บุรี)',
            'jittamas_bangpain': 'จิตตมาศ (บางประอิน)',
            'srinakorn_klongklung': 'ศรีนคร (คลองขลุง)',
            'daopaisan_nakhonsawan': 'ดาวไพศาล (นครสวรรค์)',
            'ekawitat_nonthaburi': 'เอกวิทัศน์ (นนทบุรี)',
            'daourai_sai3': 'ดาวอุไร (สาย 3)',
            'tekyong_chonburi': 'เต็กย้งทวีโชค (ชลบุรี)',
            'rungpattana_wangnoi': 'รุ่งพัฒนาดี (วังน้อย)',
        };

        const firebaseConfig = {
          apiKey: "AIzaSyDnlm_o9uJQ-uYI4Nv0w-Apmz1d3JQxCQw",
          authDomain: "fleet-fuel-management-system.firebaseapp.com",
          databaseURL: "https://fleet-fuel-management-system-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "fleet-fuel-management-system",
          storageBucket: "fleet-fuel-management-system.appspot.com",
          messagingSenderId: "870197166069",
          appId: "1:870197166069:web:e97f0a6fadb034ae912abc"
        };
        
        const ICONS = {
            Truck: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="#eab308" stroke="#eab308" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"></path></svg>`,
            ChartBar: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>`,
            Database: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 5V19A9 3 0 0 0 21 19V5"></path><path d="M3 12A9 3 0 0 0 21 12"></path></svg>`,
            IdCard: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10.5V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h12.5"></path><path d="M16 19h6"></path><path d="M19 16v6"></path><path d="M6 11h4"></path><path d="M6 15h2"></path><path d="M10 15h2"></path></svg>`,
            DocumentAdd: `<svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`,
            DocumentText: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
            Trash: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`,
            Pencil: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>`,
            Plus: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>`,
            Download: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>`,
            Refresh: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5m-5-5a9 9 0 0115.54 5.54M20 20v-5h-5m5 5a9 9 0 01-15.54-5.54" /></svg>`,
            Clear: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
            Sort: `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9M3 12h9m-9 4h13m0-4l-3-3m0 6l3-3m0 6l3 3" /></svg>`,
            SortAsc: `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9M3 12h9m-9 4h13m0-4l-3-3m0 6l3-3" /></svg>`,
            SortDesc: `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9M3 12h9m-9 4h13m0 0l-3 3m0-6l3 3m0-6l3-3" /></svg>`,
            Wallet: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 12V8a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4"></path><path d="M20 12h-8a2 2 0 0 1 0-4h8v4z"></path></svg>`,
            ChevronDown: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>`,
        };
        
        // --- Utility Functions ---
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        const minutesToHoursAndMinutes = (totalMinutes) => {
            if (totalMinutes === null || totalMinutes === undefined || isNaN(totalMinutes) || totalMinutes === 0) {
                return '';
            }
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const paddedMinutes = minutes < 10 ? '0' + minutes : minutes;
            return `${hours}.${paddedMinutes}`;
        };

        const hoursAndMinutesToMinutes = (timeString) => {
            if (!timeString || typeof timeString !== 'string') {
                return 0;
            }
            const parts = timeString.split('.');
            const hours = parseInt(parts[0], 10) || 0;
            const minutes = parseInt(parts[1], 10) || 0;
            if (isNaN(hours) || isNaN(minutes)) {
                return 0;
            }
            return (hours * 60) + minutes;
        };

        const updateFuelFormVisibility = () => {
            const isNGV = document.querySelector('input[name="fuelType"]:checked')?.value === 'ngv';
            const isSubcontractor = document.querySelector('input[name="vehicleOwnership"]:checked')?.value === 'subcontractor';

            // Get elements
            const subcontractorDetails = document.getElementById('subcontractor-details');
            const ngvCostWrapper = document.getElementById('ngv-cost-wrapper');
            const litersBlock = document.getElementById('liters-distribution-block');
            const bahtBlock = document.getElementById('baht-distribution-block');
            const shippingCostWrapper = document.getElementById('form-shipping-cost').parentElement;
            const driverAllowanceWrapper = document.getElementById('driver-allowance-wrapper');
            const kmTimeGrid = document.getElementById('km-time-grid');
            const queueSectionGrid = document.getElementById('queue-section-grid');

            if (!subcontractorDetails) return; // Exit if not on the form view

            // Set visibility based on current state
            subcontractorDetails.classList.toggle('hidden', !isSubcontractor);
            driverAllowanceWrapper.classList.toggle('hidden', isSubcontractor);
            kmTimeGrid.classList.toggle('hidden', isSubcontractor);
            if (queueSectionGrid) {
                queueSectionGrid.classList.toggle('hidden', isSubcontractor);
            }

            ngvCostWrapper.classList.toggle('hidden', !isNGV);
            litersBlock.classList.toggle('hidden', isNGV || isSubcontractor);
            bahtBlock.classList.toggle('hidden', isNGV || isSubcontractor);
            shippingCostWrapper.classList.toggle('hidden', isNGV || !isSubcontractor);
        };


        // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        // 2. APPLICATION STATE
        // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        
        let appState = {
            view: 'form', // 'form', 'dashboard', 'reports', 'data', 'vehicles', 'savings'
            isAuthenticated: false,
            routes: [],
            fuelRecords: [],
            vehicles: [],
            savingsPayouts: [],
            savingsCarryOvers: [],
            // Form-specific state
            fuelForm: {
                distributionLiters: [],
                distributionBaht: []
            },
            // Dashboard-specific state
            dashboardFilters: {
                vehicleRegistration: '',
                dateFrom: '',
                dateTo: '',
                recordLimit: 50,
                currentPage: 1,
            },
            // Reports-specific state
            reportFilters: {
                vehicleRegistration: '',
                dateFrom: '',
                dateTo: '',
            },
            // Data Management-specific state
            routeSort: { key: 'vehicleType', direction: 'asc' },
            routeFilters: {
                vehicleType: '',
                origin: '',
                destination: '',
                driverAllowance: '',
                kilometers: '',
                travelTime: '',
                transportCompany: '',
                shippingCost: '',
                loadingQueue: '',
                unloadingQueue: ''
            },
            vehicleManagementFilter: '',
            editingRoute: null,
            editingFuelRecord: null,
            editingVehicle: null,
        };

        // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        // 3. SERVICE LAYER (Data Handling & Firebase)
        // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        
        let database;

        const formatZeroAsEmpty = (value) => {
            const num = Number(value);
            if (value === '' || value === null || value === undefined || (!num && num !== 0)) return '';
            if (num === 0) return '';
            return typeof value === 'number' ? value.toLocaleString() : value;
        };

        const logisticsService = {
            initialize: () => {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();

                // Start listening to data from Firebase immediately.
                logisticsService.listenToData();
                
                // Perform initial render to show the UI.
                renderApp();
            },

            listenToData: () => {
                const routesRef = database.ref('routes');
                const fuelRecordsRef = database.ref('fuelRecords').orderByChild('date').limitToLast(200);
                const vehiclesRef = database.ref('vehicles');
                const savingsPayoutsRef = database.ref('savingsPayouts');
                const savingsCarryOversRef = database.ref('savingsCarryOvers');

                routesRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    appState.routes = data ? Object.entries(data).map(([id, value]) => ({ id, ...value })) : [];
                    if(['data', 'form'].includes(appState.view)) renderApp();
                });

                fuelRecordsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    appState.fuelRecords = data ? Object.entries(data).map(([id, value]) => ({ id, ...value }))
                        .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()) : [];
                    if(['dashboard', 'reports', 'form', 'savings'].includes(appState.view)) renderApp();
                });

                vehiclesRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    appState.vehicles = data ? Object.entries(data).map(([id, value]) => ({ id, ...value })) : [];
                    if(['vehicles', 'form'].includes(appState.view)) renderApp();
                });

                savingsPayoutsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    appState.savingsPayouts = data ? Object.entries(data).map(([id, value]) => ({ id, ...value })) : [];
                    if(appState.view === 'savings') renderApp();
                });
                
                savingsCarryOversRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    appState.savingsCarryOvers = data ? Object.entries(data).map(([id, value]) => ({ id, ...value })) : [];
                    if(appState.view === 'savings') renderApp();
                });
            },

            addRoute: (routeData) => database.ref('routes').push(routeData),
            updateRoute: (updatedRoute) => {
                const { id, ...data } = updatedRoute;
                return database.ref(`routes/${id}`).set(data);
            },
            deleteRoute: (routeId) => database.ref(`routes/${routeId}`).remove().catch(error => {
                console.error("Error deleting route:", error);
                alert("เกิดข้อผิดพลาดในการลบข้อมูลเส้นทาง: " + error.message);
            }),
            
            addFuelRecord: (record) => database.ref('fuelRecords').push(record),
            updateFuelRecord: (updatedRecord) => {
                const { id, ...data } = updatedRecord;
                return database.ref(`fuelRecords/${id}`).set(data);
            },
            deleteFuelRecord: (recordId) => database.ref(`fuelRecords/${recordId}`).remove().catch(error => {
                console.error("Error deleting fuel record:", error);
                alert("เกิดข้อผิดพลาดในการลบข้อมูล: " + error.message);
            }),

            addVehicle: (vehicleData) => database.ref('vehicles').push(vehicleData),
            updateVehicle: (updatedVehicle) => {
                const { id, ...data } = updatedVehicle;
                return database.ref(`vehicles/${id}`).set(data);
            },
            deleteVehicle: (vehicleId) => database.ref(`vehicles/${vehicleId}`).remove().catch(error => {
                console.error("Error deleting vehicle:", error);
                alert("เกิดข้อผิดพลาดในการลบข้อมูล: " + error.message);
            }),

            addSavingsPayout: (payoutData) => database.ref('savingsPayouts').push(payoutData),
            updateSavingsPayout: (updatedPayout) => {
                const { id, ...data } = updatedPayout;
                return database.ref(`savingsPayouts/${id}`).set(data);
            },
            deleteSavingsPayout: (payoutId) => database.ref(`savingsPayouts/${payoutId}`).remove().catch(error => {
                console.error("Error deleting savings payout:", error);
                alert("เกิดข้อผิดพลาดในการลบข้อมูลการจ่ายเงิน: " + error.message);
            }),
            
            addSavingsCarryOver: (carryOverData) => database.ref('savingsCarryOvers').push(carryOverData),
            updateSavingsCarryOver: (updatedCarryOver) => {
                const { id, ...data } = updatedCarryOver;
                return database.ref(`savingsCarryOvers/${id}`).set(data);
            },
            deleteSavingsCarryOver: (carryOverId) => database.ref(`savingsCarryOvers/${carryOverId}`).remove().catch(error => {
                console.error("Error deleting savings carry-over:", error);
                alert("เกิดข้อผิดพลาดในการลบข้อมูลยอดยกมา: " + error.message);
            }),

            getRoutes: () => [...appState.routes],
            getFuelRecords: () => [...appState.fuelRecords],
            getVehicles: () => [...appState.vehicles],
            
            getUniqueValues: (key) => {
                const values = appState.routes.map(route => route[key]);
                const validStrings = values.filter(v => typeof v === 'string' && v);
                return [...new Set(validStrings)].sort((a,b) => a.localeCompare(b, 'th'));
            },
            
            getUniqueCommaSeparatedValues: (key) => {
                const allValues = new Set();
                appState.routes.forEach(route => {
                    const valueString = route[key];
                    if (typeof valueString === 'string' && valueString) {
                        valueString.split(',')
                            .map(item => item.trim())
                            .filter(item => item)
                            .forEach(item => allValues.add(item));
                    }
                });
                return [...allValues].sort((a, b) => a.localeCompare(b, 'th'));
            },

            getVehicleRegistrations: () => {
                return [...new Set(appState.vehicles.map(v => v.registrationNumber))].sort();
            },
            
            findMatchingRoute: (vehicleType, origin, destination, transportCompany, queueType, queueDetails) => {
                 if (!vehicleType || !origin || !destination) return null;
                const vt = vehicleType.trim();
                const o = origin.trim();
                const d = destination.trim();
                const tc = (transportCompany || '').trim();

                return appState.routes.find(route => {
                    const baseMatch = (route.vehicleType || '').trim() === vt && 
                                      (route.origin || '').trim() === o && 
                                      (route.destination || '').trim() === d &&
                                      (route.transportCompany || '').trim() === tc;
                    
                    if (!baseMatch) return false;

                    // For company cars, we require a queue match if a queue is selected.
                    if (queueType && queueDetails && queueDetails.trim()) {
                        const qd = queueDetails.trim();
                        const queueDataKey = queueType === 'loading' ? 'loadingQueue' : 'unloadingQueue';
                        const queueDataString = route[queueDataKey];
                        
                        if (queueDataString) {
                            return queueDataString.split(',').map(item => item.trim()).includes(qd);
                        }
                        return false; // No queue data on this route, so no match.
                    }

                    // For subcontractors or if no queue is selected, the base match is sufficient.
                    return true;
                }) || null;
            },

            getFriendlyGasStationName: (key) => GAS_STATION_FRIENDLY_NAMES[key] || key,
            getAllGasStationFriendlyNames: () => GAS_STATION_FRIENDLY_NAMES,
            getAllGasStationKeys: () => GAS_STATION_KEYS,
        };


        // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        // 4. RENDER FUNCTIONS (UI Generation)
        // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

        // --- Render Helpers ---
        const renderRouteDistributionRow = (item, index, unit, isReadOnly = false) => {
            const unitText = unit === 'Liters' ? 'ลิตร' : 'บาท';
            const gasStationOptions = Object.entries(GAS_STATION_FRIENDLY_NAMES)
                .map(([key, name]) => `<option value="${key}" ${item.stationKey === key ? 'selected' : ''}>${name}</option>`)
                .join('');

            const readOnlyInputClasses = "w-full bg-slate-900 cursor-not-allowed border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white";
            const editableInputClasses = "w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent";

            return `
                <div class="distribution-row grid grid-cols-12 gap-2 items-center mb-2" data-index="${index}" data-unit="${unit}">
                    <div class="col-span-6">
                        <select data-field="stationKey" ${isReadOnly ? 'disabled' : ''} class="${isReadOnly ? readOnlyInputClasses : editableInputClasses}">
                            <option value="">เลือกปั๊มน้ำมัน</option>
                            ${gasStationOptions}
                        </select>
                    </div>
                    <div class="col-span-5">
                        <input type="number" data-field="amount" value="${item.amount || ''}" placeholder="${unitText}" ${isReadOnly ? 'readonly' : ''} class="${isReadOnly ? readOnlyInputClasses : editableInputClasses}" />
                    </div>
                    <div class="col-span-1 flex justify-center ${isReadOnly ? 'hidden' : ''}">
                        <button type="button" data-action="remove-distribution" class="text-red-500 hover:text-red-400 p-2 rounded-full transition-colors">${ICONS.Trash}</button>
                    </div>
                </div>
            `;
        };
        
        const renderApp = () => {
            const appContainer = document.getElementById('app-container');
            let viewHtml = '';
            if (appState.view === 'form') viewHtml = renderFuelRecordForm();
            if (appState.view === 'dashboard') viewHtml = renderDashboard();
            if (appState.view === 'reports') viewHtml = renderReports();
            if (appState.view === 'data') viewHtml = renderDataManagement();
            if (appState.view === 'vehicles') viewHtml = renderVehicleManagement();
            if (appState.view === 'savings') viewHtml = renderDriverSavings();

            appContainer.innerHTML = `
                ${renderHeader()}
                <main class="container mx-auto px-6 py-8">
                    ${viewHtml}
                </main>
                <footer class="text-center py-4 text-gray-500 text-sm">
                    <p>NeoSiamLogistics & Transport Fuel Management © 2024</p>
                </footer>
                ${renderModal()}
                ${renderAuthModal()}
            `;
            attachEventListeners();
        };

        const renderHeader = () => {
            const navButton = (targetView, icon, text) => `
                <button
                    data-view="${targetView}"
                    class="nav-button flex items-center gap-2 px-4 py-2 rounded-md transition-colors duration-200 ${
                        appState.view === targetView
                            ? 'bg-accent text-white font-semibold shadow-lg'
                            : 'bg-neutral/60 hover:bg-neutral text-gray-300'
                    }"
                >
                    ${icon}
                    <span class="hidden sm:inline">${text}</span>
                </button>
            `;

            return `
                <header class="bg-neutral shadow-lg sticky top-0 z-30">
                    <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="bg-gray-200 p-2 rounded-full">
                               <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="#0369a1"><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"></path></svg>
                            </div>
                            <h1 class="text-2xl sm:text-3xl font-bold text-white tracking-wider">NeoSiamLogistics & Transport Fuel</h1>
                        </div>
                        <div class="flex items-center gap-2 sm:gap-4">
                            ${navButton('form', ICONS.Truck, 'บันทึกน้ำมัน')}
                            ${navButton('dashboard', ICONS.ChartBar, 'แดชบอร์ด')}
                            ${navButton('reports', ICONS.DocumentText, 'รายงาน')}
                            ${navButton('savings', ICONS.Wallet, 'เงินสะสม')}
                            ${navButton('vehicles', ICONS.IdCard, 'จัดการทะเบียนรถ')}
                            ${navButton('data', ICONS.Database, 'จัดการเส้นทาง')}
                        </div>
                    </nav>
                </header>
            `;
        };

        const renderCard = (content, className = '') => `<div class="bg-neutral rounded-xl shadow-lg p-6 ${className}">${content}</div>`;

        const renderAutocomplete = (id, label, placeholder, options) => {
            return `
                <div class="relative autocomplete-container" data-id="${id}">
                    <label class="block text-base font-medium text-gray-400 mb-1">${label}</label>
                    <input
                        type="text"
                        id="${id}"
                        placeholder="${placeholder}"
                        autocomplete="off"
                        class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent"
                    />
                    <div id="${id}-suggestions" class="hidden absolute z-20 w-full mt-1 bg-slate-800 border border-slate-600 rounded-md shadow-lg max-h-60 overflow-y-auto"></div>
                </div>
            `;
        };

        // --- View: Fuel Record Form ---
        const renderFuelRecordForm = () => {
            const transportCompanyOptions = logisticsService.getUniqueValues('transportCompany')
                .map(company => `<option value="${company}">${company}</option>`)
                .join('');
            return `
                <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-2">
                        ${renderCard(`
                            <h2 class="text-3xl font-bold text-white mb-6 border-b border-slate-600 pb-2 flex items-center gap-2">
                                ${ICONS.DocumentAdd} บันทึกรายการน้ำมันใหม่
                            </h2>
                            <form id="fuel-record-form" class="space-y-6">
                                <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                                    <div>
                                        <label class="block text-base font-medium text-gray-400 mb-1">วันที่</label>
                                        <input type="date" id="form-date" value="${new Date().toISOString().split('T')[0]}" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                                    </div>
                                    ${renderAutocomplete('form-vehicle-registration', 'ทะเบียนรถ', 'ค้นหาทะเบียนรถ', logisticsService.getVehicleRegistrations())}
                                    <div>
                                        <label class="block text-base font-medium text-gray-400 mb-1">ทะเบียนหาง</label>
                                        <input type="text" id="form-trailer-registration" placeholder="ทะเบียนส่วนหาง" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                                    </div>
                                    <div>
                                        <label class="block text-base font-medium text-gray-400 mb-1">ชื่อพนักงานขับรถ</label>
                                        <input type="text" id="form-driver-name" placeholder="ชื่อจะแสดงอัตโนมัติ (แก้ไขได้)" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                                    </div>
                                </div>
                                 
                                <div>
                                    <label class="block text-base font-medium text-gray-400 mb-1">ประเภทรถ (สังกัด)</label>
                                    <div id="vehicle-ownership-radios" class="flex items-center gap-6">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="vehicleOwnership" value="company" checked class="radio radio-primary text-accent focus:ring-accent" />
                                            <span>รถบริษัท</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="vehicleOwnership" value="subcontractor" class="radio radio-primary text-accent focus:ring-accent" />
                                            <span>รถร่วมขนส่ง</span>
                                        </label>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-base font-medium text-gray-400 mb-1">ประเภทเชื้อเพลิง</label>
                                    <div id="fuel-type-radios" class="flex items-center gap-6">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="fuelType" value="diesel" checked class="radio radio-primary text-accent focus:ring-accent" />
                                            <span>Diesel fuel</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="fuelType" value="ngv" class="radio radio-primary text-accent focus:ring-accent" />
                                            <span>NGV</span>
                                        </label>
                                    </div>
                                </div>

                                <div id="subcontractor-details" class="hidden space-y-4 p-4 border border-slate-600 rounded-lg">
                                    <div>
                                        <label class="block text-base font-medium text-gray-400 mb-1">บริษัทขนส่ง <span class="text-red-400">*</span></label>
                                        <select id="form-transport-company" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent">
                                            <option value="">-- กรุณาเลือกบริษัทขนส่ง --</option>
                                            ${transportCompanyOptions}
                                        </select>
                                    </div>
                                </div>
                                
                                ${renderAutocomplete('form-vehicle-type', 'ประเภทรถ', 'ค้นหาประเภทรถ', logisticsService.getUniqueValues('vehicleType'))}
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    ${renderAutocomplete('form-origin', 'ต้นทาง', 'ค้นหาต้นทาง', logisticsService.getUniqueValues('origin'))}
                                    ${renderAutocomplete('form-destination', 'ปลายทาง', 'ค้นหาปลายทาง', logisticsService.getUniqueValues('destination'))}
                                </div>
                                
                                <div id="queue-section-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-base font-medium text-gray-400 mb-1">ประเภทคิว</label>
                                        <div id="queue-type-radios" class="flex items-center gap-6">
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="radio" name="queueType" value="loading" class="radio radio-primary text-accent focus:ring-accent" />
                                                <span>คิวขาขึ้น</span>
                                            </label>
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="radio" name="queueType" value="unloading" class="radio radio-primary text-accent focus:ring-accent" />
                                                <span>คิวถ่าย</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div id="queue-details-wrapper" class="hidden">
                                        <label class="block text-base font-medium text-gray-400 mb-1">รายละเอียดคิว</label>
                                        <select id="form-queue-details" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent">
                                            <!-- Options will be populated dynamically -->
                                        </select>
                                    </div>
                                </div>

                                <div id="ngv-cost-wrapper" class="hidden">
                                    <label class="block text-base font-medium text-gray-400 mb-1">ค่าก๊าซ NGV (บาท)</label>
                                    <input type="number" id="form-ngv-cost" placeholder="ระบุจำนวนเงิน" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                                </div>

                                <!-- Liters Distribution -->
                                <div id="liters-distribution-block" class="space-y-4 rounded-lg border border-slate-600 p-4">
                                    <div class="flex justify-between items-center">
                                        <h3 class="font-semibold text-lg text-white">การกระจายน้ำมัน (ลิตร)</h3>
                                        <div class="flex items-center gap-2">
                                            <label class="text-base font-medium text-gray-400">ปริมาณรวม</label>
                                            <input type="number" id="form-total-liters" placeholder="0" readonly class="w-28 text-right bg-slate-900 cursor-not-allowed border border-slate-600 rounded-md shadow-sm px-3 py-1 text-white" />
                                        </div>
                                    </div>
                                    <div id="distribution-list-liters"></div>
                                    <button type="button" id="add-distribution-btn-liters" class="hidden w-full border-2 border-dashed border-slate-500 hover:bg-slate-700/50 text-gray-300 font-semibold py-2 px-4 rounded-lg transition">+ เพิ่มจุดเติมน้ำมัน (ลิตร)</button>
                                </div>
                                
                                <!-- Baht Distribution -->
                                <div id="baht-distribution-block" class="space-y-4 rounded-lg border border-slate-600 p-4">
                                     <div class="flex justify-between items-center">
                                        <h3 class="font-semibold text-lg text-white">การกระจายน้ำมัน (บาท)</h3>
                                        <div class="flex items-center gap-2">
                                            <label class="text-base font-medium text-gray-400">ปริมาณรวม</label>
                                            <input type="number" id="form-total-baht" placeholder="0" readonly class="w-28 text-right bg-slate-900 cursor-not-allowed border border-slate-600 rounded-md shadow-sm px-3 py-1 text-white" />
                                        </div>
                                    </div>
                                    <div id="distribution-list-baht"></div>
                                    <button type="button" id="add-distribution-btn-baht" class="hidden w-full border-2 border-dashed border-slate-500 hover:bg-slate-700/50 text-gray-300 font-semibold py-2 px-4 rounded-lg transition">+ เพิ่มจุดเติมน้ำมัน (บาท)</button>
                                </div>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                     <div>
                                        <label class="block text-base font-medium text-gray-400 mb-1">ค่าขนส่ง (บาท)</label>
                                        <input type="number" id="form-shipping-cost" placeholder="ข้อมูลจะแสดงอัตโนมัติ" readonly class="w-full bg-slate-900 cursor-not-allowed border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                                    </div>
                                    <div id="driver-allowance-wrapper">
                                       <label class="block text-base font-medium text-gray-400 mb-1">เบี้ยขับ (บาท)</label>
                                       <input type="number" id="form-driver-allowance" placeholder="ข้อมูลจะแสดงอัตโนมัติ" readonly class="w-full bg-slate-900 cursor-not-allowed border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                                    </div>
                                </div>
                                
                                <div id="km-time-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                       <label class="block text-base font-medium text-gray-400 mb-1">ระยะทาง (กม.)</label>
                                       <input type="number" id="form-kilometers" placeholder="ข้อมูลจะแสดงอัตโนมัติ" readonly class="w-full bg-slate-900 cursor-not-allowed border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                                    </div>
                                    <div>
                                       <label class="block text-base font-medium text-gray-400 mb-1">เวลาเดินทาง (ชม.)</label>
                                       <input type="text" id="form-travel-time" placeholder="ข้อมูลจะแสดงอัตโนมัติ" readonly class="w-full bg-slate-900 cursor-not-allowed border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                                    </div>
                                </div>

                                <div>
                                   <label class="block text-base font-medium text-gray-400 mb-1">รายละเอียด</label>
                                   <textarea id="form-details" placeholder="รายละเอียดเพิ่มเติม" rows="3" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent"></textarea>
                                </div>

                                <div>
                                   <label class="block text-base font-medium text-gray-400 mb-1">หมายเหตุ</label>
                                   <textarea id="form-notes" placeholder="หมายเหตุเพิ่มเติมเกี่ยวกับการเดินทาง" rows="3" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent"></textarea>
                                </div>
                                <div class="flex justify-end pt-4 gap-4">
                                    <button type="button" id="reset-fuel-form-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">ล้างข้อมูล</button>
                                    <button type="submit" class="bg-primary hover:bg-secondary text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">บันทึกรายการ</button>
                                </div>
                                <div id="form-status" class="mt-4"></div>
                            </form>
                        `)}
                    </div>
                    <div class="md:col-span-1">
                        ${renderCard('<div id="vlookup-card-content"></div>', 'sticky top-28')}
                    </div>
                </div>
            `;
        };
        
        const getFilteredFuelRecords = () => {
            const filters = appState.dashboardFilters;
            const records = logisticsService.getFuelRecords();
            return records.filter(record => {
                const recordDate = new Date(record.date);
                const dateFrom = filters.dateFrom ? new Date(filters.dateFrom) : null;
                const dateTo = filters.dateTo ? new Date(filters.dateTo) : null;

                if (filters.vehicleRegistration && !(record.vehicleRegistration || '').toUpperCase().includes(filters.vehicleRegistration.toUpperCase())) return false;
                if (dateFrom && recordDate < dateFrom) return false;
                if (dateTo && recordDate > dateTo) return false;
                return true;
            });
        };

        const renderFuelRecordStationBreakdown = (record) => {
            const liters = record.fuelDistributionLiters || {};
            const baht = record.fuelDistributionBaht || {};
            const allStations = new Set([...Object.keys(liters), ...Object.keys(baht)]);

            const hasStationData = allStations.size > 0;
            const hasDetails = record.details && record.details.trim() !== '';
            const hasNotes = record.notes && record.notes.trim() !== '';

            if (!hasStationData && !hasDetails && !hasNotes) {
                return `<div class="p-4 text-center text-gray-500">ไม่มีข้อมูลเพิ่มเติมสำหรับรายการนี้</div>`;
            }

            const stationList = Array.from(allStations).map(key => `
                <div class="flex justify-between py-1">
                    <dt class="text-gray-400">${logisticsService.getFriendlyGasStationName(key)}:</dt>
                    <dd class="font-mono text-right">
                        ${liters[key] ? `<span class="text-accent">${liters[key].toLocaleString()} L</span>` : ''}
                        ${liters[key] && baht[key] ? `<span class="text-gray-500 mx-2">/</span>` : ''}
                        ${baht[key] ? `<span class="text-yellow-400">${baht[key].toLocaleString()} B</span>` : ''}
                    </dd>
                </div>
            `).join('');

            return `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h4 class="font-bold text-gray-300 mb-2">รายละเอียดการเติมน้ำมัน</h4>
                        ${hasStationData ? `
                            <dl class="space-y-1 text-base max-w-md">
                                ${stationList}
                            </dl>
                        ` : `<p class="text-gray-500 italic">ไม่มีข้อมูลการกระจายน้ำมัน</p>`}
                    </div>
                    <div>
                        ${hasDetails ? `
                            <div class="mb-4">
                                <h4 class="font-bold text-gray-300 mb-2">รายละเอียด</h4>
                                <p class="text-base text-gray-400 whitespace-pre-wrap">${record.details}</p>
                            </div>
                        ` : ''}
                        ${hasNotes ? `
                            <div>
                                <h4 class="font-bold text-gray-300 mb-2">หมายเหตุ</h4>
                                <p class="text-base text-gray-400 whitespace-pre-wrap">${record.notes}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }


        const renderDashboardContent = () => {
            const allFilteredRecords = getFilteredFuelRecords();
            
            const totalLiters = allFilteredRecords
                .filter(r => r.fuelType !== 'ngv') // Exclude NGV from liters sum
                .reduce((sum, record) => sum + (record.totalLiters || 0), 0);
            const totalBaht = allFilteredRecords.reduce((sum, record) => sum + (record.totalBaht || 0), 0);

            const limit = appState.dashboardFilters.recordLimit;
            const currentPage = appState.dashboardFilters.currentPage || 1;
            const itemsPerPage = (limit === 'all' || !limit) ? allFilteredRecords.length : parseInt(limit, 10);
            const totalPages = (itemsPerPage > 0 && allFilteredRecords.length > 0) ? Math.ceil(allFilteredRecords.length / itemsPerPage) : 1;
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedRecords = itemsPerPage > 0 ? allFilteredRecords.slice(startIndex, endIndex) : [];


            const latestRecordsTableRows = paginatedRecords.map(record => {
                const ownershipText = record.vehicleOwnership === 'subcontractor' ? 'รถร่วม' : 'รถบริษัท';
                let allowanceCellHtml;
                if ((record.vehicleOwnership === 'company' || !record.vehicleOwnership) && record.driverAllowance > 0) {
                    const netAllowance = (record.driverAllowance || 0) - 200;
                    allowanceCellHtml = `
                        <div class="flex flex-col items-end">
                            <span>${netAllowance > 0 ? netAllowance.toLocaleString() : '0'}</span>
                            <span class="text-sm text-yellow-400">(สะสม 200)</span>
                        </div>`;
                } else {
                    allowanceCellHtml = formatZeroAsEmpty(record.driverAllowance);
                }

                const isNGV = record.fuelType === 'ngv';
                const fuelAmountCell = isNGV ? '<span class="text-green-400">NGV</span>' : formatZeroAsEmpty(record.totalLiters);
                const fuelCostCell = formatZeroAsEmpty(record.totalBaht);
                const shippingCostCell = isNGV ? '-' : formatZeroAsEmpty(record.shippingCost);
                const fuelTypeDisplay = isNGV ? 'NGV' : 'Diesel';
                const queueDisplay = record.queueType && record.queueType !== 'none'
                    ? `${record.queueType === 'loading' ? 'ขึ้น' : 'ถ่าย'}: ${record.queueDetails || ''}`
                    : '-';

                const mainRow = `
                <tr class="border-b border-slate-700 hover:bg-slate-700/20">
                    <td class="p-2 text-center align-middle">
                         <button data-action="toggle-fuel-record-details" data-target-id="${record.id}" class="p-2 rounded-full hover:bg-slate-600">
                           ${ICONS.ChevronDown}
                        </button>
                    </td>
                    <td class="p-3 align-middle whitespace-nowrap">${record.date}</td>
                    <td class="p-3 font-mono align-middle">${record.vehicleRegistration}</td>
                    <td class="p-3 font-mono align-middle">${record.trailerRegistration || '-'}</td>
                    <td class="p-3 align-middle max-w-[150px] break-words">${record.driverName || ''}</td>
                    <td class="p-3 align-middle max-w-[200px] break-words">${record.vehicleType} (${ownershipText})</td>
                    <td class="p-3 align-middle max-w-[250px] break-words">${record.transportCompany || '-'}</td>
                    <td class="p-3 align-middle max-w-[300px] break-words">${record.origin} → ${record.destination}</td>
                    <td class="p-3 align-middle">${queueDisplay}</td>
                    <td class="p-3 text-right font-mono font-semibold text-accent align-middle">${fuelAmountCell}</td>
                    <td class="p-3 text-right font-mono font-semibold text-accent align-middle">${fuelCostCell}</td>
                    <td class="p-3 text-right font-mono font-semibold text-info align-middle">${shippingCostCell}</td>
                    <td class="p-3 text-right font-mono font-semibold text-success align-middle">${allowanceCellHtml}</td>
                    <td class="p-3 text-right font-mono align-middle">${formatZeroAsEmpty(record.kilometers)}</td>
                    <td class="p-3 text-right font-mono align-middle">${minutesToHoursAndMinutes(record.travelTime)}</td>
                    <td class="p-3 align-middle">${fuelTypeDisplay}</td>
                    <td class="p-3 text-center align-middle">
                        <div class="flex justify-center gap-2">
                            <button data-action="edit-fuel-record" data-id="${record.id}" class="text-blue-400 hover:text-blue-300 p-2 rounded-full transition-colors">${ICONS.Pencil}</button>
                            <button data-action="delete-fuel-record" data-id="${record.id}" class="text-red-500 hover:text-red-400 p-2 rounded-full transition-colors">${ICONS.Trash}</button>
                        </div>
                    </td>
                </tr>
                `;

                const detailsRow = `
                <tr id="details-fuel-${record.id}" class="hidden">
                    <td colspan="17" class="p-0 border-b-2 border-slate-600">
                        <div class="bg-slate-900/50 p-6">
                            ${renderFuelRecordStationBreakdown(record)}
                        </div>
                    </td>
                </tr>`;

                return mainRow + detailsRow;
            }).join('');

            const stationKeys = logisticsService.getAllGasStationKeys();
            const friendlyNames = logisticsService.getAllGasStationFriendlyNames();

            // OPTIMIZATION: Group records by station in a single pass to prevent lag on filtering.
            const stationRecordsGroup = {};
            stationKeys.forEach(key => { stationRecordsGroup[key] = []; });

            allFilteredRecords.forEach(record => {
                const allStationKeysInRecord = new Set([
                    ...Object.keys(record.fuelDistributionLiters || {}),
                    ...Object.keys(record.fuelDistributionBaht || {})
                ]);
                
                allStationKeysInRecord.forEach(key => {
                    if (stationRecordsGroup[key]) {
                        stationRecordsGroup[key].push(record);
                    }
                });
            });

            const stationTablesHtml = stationKeys.map(key => {
                const stationRecords = stationRecordsGroup[key];
                
                const tableRows = stationRecords.map(record => {
                    const amountLiters = record.fuelDistributionLiters?.[key] || 0;
                    const amountBaht = record.fuelDistributionBaht?.[key] || 0;
                   
                    return `
                        <tr class="border-b border-slate-600 hover:bg-slate-700/20">
                            <td class="p-3 whitespace-nowrap">${record.date}</td>
                            <td class="p-3 font-mono whitespace-nowrap">${record.vehicleRegistration}</td>
                            <td class="p-3 whitespace-nowrap">${record.origin} → ${record.destination}</td>
                            <td class="p-3 text-right font-semibold text-accent whitespace-nowrap">${formatZeroAsEmpty(amountLiters)}</td>
                            <td class="p-3 text-right font-semibold text-accent whitespace-nowrap">${formatZeroAsEmpty(amountBaht)}</td>
                        </tr>
                    `;
                }).join('');

                return renderCard(`
                    <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 11h1.5a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-1.5a2 2 0 0 1-2-2v-2a1 1 0 0 0-1-1h-2a1 1 0 0 0-1 1v2a2 2 0 0 1-2 2H5.5a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2H7"></path><path d="M14 11V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v7"></path><path d="M4 15h5"></path><path d="M15 4h2"></path></svg>
                        <span>${friendlyNames[key] || key}</span>
                    </h3>
                    <div class="overflow-x-auto max-h-[300px]">
                        <table class="w-full text-left table-auto">
                            <thead class="bg-slate-800 text-base text-gray-400 uppercase sticky top-0 z-10">
                                <tr>
                                    <th class="p-3 whitespace-nowrap">วันที่</th>
                                    <th class="p-3 whitespace-nowrap">ทะเบียน</th>
                                    <th class="p-3 whitespace-nowrap">เส้นทาง</th>
                                    <th class="p-3 text-right whitespace-nowrap">ปริมาณ (ลิตร)</th>
                                    <th class="p-3 text-right whitespace-nowrap">ค่าใช้จ่าย (บาท)</th>
                                </tr>
                            </thead>
                            <tbody class="text-base">
                                ${stationRecords.length > 0 ? tableRows : `<tr><td colspan="5" class="text-center py-8 text-gray-500">ไม่มีข้อมูลการเติมน้ำมัน</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                `);
            }).join('');
            
            const exportBtn = document.getElementById('export-excel-btn');
            if (exportBtn) {
                 exportBtn.disabled = allFilteredRecords.length === 0;
            }

            const allowanceRecords = allFilteredRecords.filter(r => r.driverAllowance && r.driverAllowance > 0);
            const totalAllowance = allowanceRecords.reduce((sum, record) => {
                const allowance = record.driverAllowance || 0;
                if ((record.vehicleOwnership === 'company' || !record.vehicleOwnership) && allowance > 0) {
                    return sum + (allowance > 200 ? allowance - 200 : 0);
                }
                return sum + allowance;
            }, 0);

            const allowanceTableRows = allowanceRecords.map(record => {
                 let allowanceCellHtml;
                if ((record.vehicleOwnership === 'company' || !record.vehicleOwnership) && record.driverAllowance > 0) {
                    const netAllowance = (record.driverAllowance || 0) - 200;
                    allowanceCellHtml = `
                        <div class="flex flex-col items-end">
                            <span>${netAllowance > 0 ? netAllowance.toLocaleString() : '0'}</span>
                            <span class="text-sm text-yellow-400">(สะสม 200)</span>
                        </div>`;
                } else {
                    allowanceCellHtml = formatZeroAsEmpty(record.driverAllowance);
                }
                return `
                <tr class="border-b border-slate-600 hover:bg-slate-700/20">
                    <td class="p-3">${record.date}</td>
                    <td class="p-3 font-mono">${record.vehicleRegistration}</td>
                    <td class="p-3">${record.driverName || ''}</td>
                    <td class="p-3">${record.vehicleType}</td>
                    <td class="p-3">${record.origin} → ${record.destination}</td>
                    <td class="p-3 text-right font-semibold text-success">${allowanceCellHtml}</td>
                </tr>
            `}).join('');

            const allowanceSummaryTableHtml = renderCard(`
                <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path></svg>
                    <span>สรุปยอดเบี้ยขับ</span>
                </h3>
                <div class="overflow-x-auto max-h-[400px]">
                    <table class="w-full text-left table-auto">
                        <thead class="bg-slate-800 text-base text-gray-400 uppercase sticky top-0 z-10">
                            <tr>
                                <th class="p-3 whitespace-nowrap">วันที่</th>
                                <th class="p-3 whitespace-nowrap">ทะเบียน</th>
                                <th class="p-3 whitespace-nowrap">ชื่อพนักงานขับรถ</th>
                                <th class="p-3 whitespace-nowrap">ประเภทรถ</th>
                                <th class="p-3 whitespace-nowrap">เส้นทาง</th>
                                <th class="p-3 text-right whitespace-nowrap">เบี้ยขับ (บาท)</th>
                            </tr>
                        </thead>
                        <tbody class="text-base">
                            ${allowanceRecords.length > 0 ? allowanceTableRows : `<tr><td colspan="6" class="text-center py-8 text-gray-500">ไม่มีข้อมูลเบี้ยขับ</td></tr>`}
                        </tbody>
                        ${allowanceRecords.length > 0 ? `
                        <tfoot class="bg-slate-800 font-bold">
                            <tr>
                                <td colspan="5" class="p-3 text-right">ยอดรวมสุทธิ</td>
                                <td class="p-3 text-right text-success">${totalAllowance.toLocaleString()}</td>
                            </tr>
                        </tfoot>
                        ` : ''}
                    </table>
                </div>
            `);

            const subcontractorRecords = allFilteredRecords.filter(r => r.vehicleOwnership === 'subcontractor');
            const totalShippingCost = subcontractorRecords.reduce((sum, record) => sum + (record.shippingCost || 0), 0);
            
            const subcontractorTableRows = subcontractorRecords.map(record => `
                <tr class="border-b border-slate-600 hover:bg-slate-700/20">
                    <td class="p-3">${record.date}</td>
                    <td class="p-3 font-mono">${record.vehicleRegistration}</td>
                    <td class="p-3">${record.vehicleType}</td>
                    <td class="p-3">${record.transportCompany || ''}</td>
                    <td class="p-3">${record.driverName || ''}</td>
                    <td class="p-3">${record.origin} → ${record.destination}</td>
                    <td class="p-3 text-right font-semibold text-info">${formatZeroAsEmpty(record.shippingCost)}</td>
                </tr>
            `).join('');

            const subcontractorSummaryTableHtml = renderCard(`
                <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-info" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                    <span>รายงานรถร่วมขนส่ง</span>
                </h3>
                <div class="overflow-x-auto max-h-[400px]">
                    <table class="w-full text-left table-auto">
                        <thead class="bg-slate-800 text-base text-gray-400 uppercase sticky top-0 z-10">
                            <tr>
                                <th class="p-3 whitespace-nowrap">วันที่</th>
                                <th class="p-3 whitespace-nowrap">ทะเบียน</th>
                                <th class="p-3 whitespace-nowrap">ประเภทรถ</th>
                                <th class="p-3 whitespace-nowrap">ชื่อบริษัท</th>
                                <th class="p-3 whitespace-nowrap">ชื่อพนักงานขับรถ</th>
                                <th class="p-3 whitespace-nowrap">เส้นทาง</th>
                                <th class="p-3 text-right whitespace-nowrap">ค่าขนส่ง (บาท)</th>
                            </tr>
                        </thead>
                        <tbody class="text-base">
                            ${subcontractorRecords.length > 0 ? subcontractorTableRows : `<tr><td colspan="7" class="text-center py-8 text-gray-500">ไม่มีข้อมูลรถร่วมขนส่ง</td></tr>`}
                        </tbody>
                        ${subcontractorRecords.length > 0 ? `
                        <tfoot class="bg-slate-800 font-bold">
                            <tr>
                                <td colspan="6" class="p-3 text-right">ยอดรวมค่าขนส่ง</td>
                                <td class="p-3 text-right text-info">${totalShippingCost.toLocaleString()}</td>
                            </tr>
                        </tfoot>
                        ` : ''}
                    </table>
                </div>
            `);

            const ngvRecords = allFilteredRecords.filter(r => r.fuelType === 'ngv');
            const totalNgvCost = ngvRecords.reduce((sum, record) => sum + (record.totalBaht || 0), 0);
            
            const ngvTableRows = ngvRecords.map(record => `
                <tr class="border-b border-slate-600 hover:bg-slate-700/20">
                    <td class="p-3">${record.date}</td>
                    <td class="p-3 font-mono">${record.vehicleRegistration}</td>
                    <td class="p-3">${record.driverName || ''}</td>
                    <td class="p-3">${record.vehicleType}</td>
                    <td class="p-3">${record.origin} → ${record.destination}</td>
                    <td class="p-3 text-right font-semibold text-green-400">${formatZeroAsEmpty(record.totalBaht)}</td>
                </tr>
            `).join('');

            const ngvSummaryTableHtml = renderCard(`
                <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2c-3.3 0-6 2.7-6 6v8a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8c0-3.3-2.7-6-6-6z"></path><path d="M12 12v-2"></path><path d="M12 18h.01"></path></svg>
                    <span>รายงาน ค่าก๊าซ NGV</span>
                </h3>
                <div class="overflow-x-auto max-h-[400px]">
                    <table class="w-full text-left table-auto">
                        <thead class="bg-slate-800 text-base text-gray-400 uppercase sticky top-0 z-10">
                            <tr>
                                <th class="p-3 whitespace-nowrap">วันที่</th>
                                <th class="p-3 whitespace-nowrap">ทะเบียน</th>
                                <th class="p-3 whitespace-nowrap">ชื่อพนักงานขับรถ</th>
                                <th class="p-3 whitespace-nowrap">ประเภทรถ</th>
                                <th class="p-3 whitespace-nowrap">เส้นทาง</th>
                                <th class="p-3 text-right whitespace-nowrap">ค่าก๊าซ NGV (บาท)</th>
                            </tr>
                        </thead>
                        <tbody class="text-base">
                            ${ngvRecords.length > 0 ? ngvTableRows : `<tr><td colspan="6" class="text-center py-8 text-gray-500">ไม่มีข้อมูลค่าก๊าซ NGV</td></tr>`}
                        </tbody>
                        ${ngvRecords.length > 0 ? `
                        <tfoot class="bg-slate-800 font-bold">
                            <tr>
                                <td colspan="5" class="p-3 text-right">ยอดรวมค่าก๊าซ NGV</td>
                                <td class="p-3 text-right text-green-400">${totalNgvCost.toLocaleString()}</td>
                            </tr>
                        </tfoot>
                        ` : ''}
                    </table>
                </div>
            `);
            
            const limitOptions = [10, 20, 50, 100, 'all'].map(val => 
                `<option value="${val}" ${appState.dashboardFilters.recordLimit == val ? 'selected' : ''}>${val === 'all' ? 'ทั้งหมด' : val}</option>`
            ).join('');

            let paginationHtml = '';
            if (allFilteredRecords.length > 0) {
                const paginationControls = totalPages > 1 ? `
                    <div class="flex items-center gap-2">
                        <button data-action="paginate-prev" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-md transition-colors disabled:bg-slate-800 disabled:text-gray-500 disabled:cursor-not-allowed" ${currentPage === 1 ? 'disabled' : ''}>
                            ก่อนหน้า
                        </button>
                        <span class="text-base font-semibold px-2">หน้า ${currentPage} / ${totalPages}</span>
                        <button data-action="paginate-next" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded-md transition-colors disabled:bg-slate-800 disabled:text-gray-500 disabled:cursor-not-allowed" ${currentPage >= totalPages ? 'disabled' : ''}>
                            ถัดไป
                        </button>
                    </div>` : '';
                
                paginationHtml = `
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-slate-600">
                    <span class="text-sm text-gray-400">แสดง ${startIndex + 1} ถึง ${Math.min(endIndex, allFilteredRecords.length)} จาก ${allFilteredRecords.length} รายการ</span>
                    ${paginationControls}
                </div>`;
            }

            return `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${renderCard(`<h3 class="text-lg text-gray-400">จำนวนรายการทั้งหมด</h3><p class="text-4xl font-bold text-accent">${(allFilteredRecords.length || 0).toLocaleString()}</p>`, 'text-center')}
                    ${renderCard(`<h3 class="text-lg text-gray-400">ปริมาณน้ำมันทั้งหมด</h3><p class="text-4xl font-bold text-accent">${(totalLiters || 0).toLocaleString()} <span class="text-2xl">ลิตร</span></p>`, 'text-center')}
                    ${renderCard(`<h3 class="text-lg text-gray-400">ค่าใช้จ่ายน้ำมันทั้งหมด</h3><p class="text-4xl font-bold text-accent">${(totalBaht || 0).toLocaleString()}<span class="text-2xl"> บาท</span></p>`, 'text-center')}
                </div>

                <div class="space-y-6">
                    <h2 class="text-3xl font-bold text-white mt-8 border-b border-slate-600 pb-2">สรุปยอดเติมน้ำมันรายปั๊ม</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        ${stationTablesHtml}
                    </div>
                </div>
                
                <div class="mt-8">
                    ${allowanceSummaryTableHtml}
                </div>

                <div class="mt-8">
                    ${subcontractorSummaryTableHtml}
                </div>

                <div class="mt-8">
                    ${ngvSummaryTableHtml}
                </div>

                <div class="mt-8">
                ${renderCard(`
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                        <h3 class="text-2xl font-bold">รายการน้ำมันล่าสุดทั้งหมด</h3>
                        <div class="flex items-center gap-2">
                            <label for="record-limit-select" class="text-base text-gray-400">แสดง:</label>
                            <select id="record-limit-select" class="bg-slate-800 border border-slate-600 rounded-md px-2 py-1 text-white focus:outline-none focus:ring-1 focus:ring-accent">
                                ${limitOptions}
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-800 text-base text-gray-400 uppercase sticky top-0 z-10">
                                <tr>
                                    <th class="p-2 w-12"></th>
                                    <th class="p-3">วันที่</th>
                                    <th class="p-3">ทะเบียน</th>
                                    <th class="p-3">ทะเบียนหาง</th>
                                    <th class="p-3">คนขับ</th>
                                    <th class="p-3">ประเภทรถ (สังกัด)</th>
                                    <th class="p-3">บริษัทขนส่ง</th>
                                    <th class="p-3">เส้นทาง</th>
                                    <th class="p-3">คิว</th>
                                    <th class="p-3 text-right">ปริมาณเชื้อเพลิง</th>
                                    <th class="p-3 text-right">ค่าเชื้อเพลิง (บาท)</th>
                                    <th class="p-3 text-right">ค่าขนส่ง (บาท)</th>
                                    <th class="p-3 text-right">เบี้ยขับ (บาท)</th>
                                    <th class="p-3 text-right">ระยะทาง (กม.)</th>
                                    <th class="p-3 text-right">เวลา (ชม.)</th>
                                    <th class="p-3">ประเภทเชื้อเพลิง</th>
                                    <th class="p-3 text-center">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-table-body">${latestRecordsTableRows}</tbody>
                        </table>
                        ${paginatedRecords.length === 0 ? '<p class="text-center py-8 text-gray-500">ไม่พบรายการที่ตรงกัน</p>' : ''}
                    </div>
                    ${paginationHtml}
                `)}
                </div>
            `;
        }


        // --- View: Dashboard ---
        const renderDashboard = () => {
             const filters = appState.dashboardFilters;
             const filteredRecords = getFilteredFuelRecords();

            return `
                <div class="space-y-8">
                    ${renderCard(`
                        <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                             <h2 class="text-3xl font-bold">ตัวกรองแดชบอร์ด</h2>
                            <div class="flex items-center gap-2">
                                <button id="clear-dashboard-filters-btn" class="flex items-center gap-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                    ${ICONS.Clear} ล้างตัวกรอง
                                </button>
                                <button id="refresh-dashboard-btn" class="flex items-center gap-2 bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                    ${ICONS.Refresh} รีเฟรช
                                </button>
                                <button id="export-excel-btn" ${filteredRecords.length === 0 ? 'disabled' : ''} class="flex items-center gap-2 bg-success hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-slate-600 disabled:cursor-not-allowed disabled:transform-none">
                                    ${ICONS.Download} Export to Excel
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="dashboard-filters">
                            <input name="vehicleRegistration" value="${filters.vehicleRegistration}" placeholder="กรองตามทะเบียนรถ" class="bg-slate-800 border border-slate-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                            <input name="dateFrom" type="date" value="${filters.dateFrom}" class="bg-slate-800 border border-slate-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                            <input name="dateTo" type="date" value="${filters.dateTo}" class="bg-slate-800 border border-slate-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                        </div>
                    `)}

                    <div id="dashboard-content" class="space-y-8">
                       ${renderDashboardContent()}
                    </div>
                </div>
            `;
        };

        // --- View: Reports ---
        const getFilteredQueueRecords = (queueType) => {
            const filters = appState.reportFilters;
            const records = logisticsService.getFuelRecords();
            return records.filter(record => {
                if (record.queueType !== queueType) return false;

                const recordDate = new Date(record.date);
                const dateFrom = filters.dateFrom ? new Date(filters.dateFrom) : null;
                const dateTo = filters.dateTo ? new Date(filters.dateTo) : null;

                if (filters.vehicleRegistration && !(record.vehicleRegistration || '').toUpperCase().includes(filters.vehicleRegistration.toUpperCase())) return false;
                if (dateFrom && recordDate < dateFrom) return false;
                if (dateTo && recordDate > dateTo) return false;
                return true;
            });
        };

        const renderQueueReportTable = (title, records) => {
            const tableRows = records.map(record => {
                const ownershipText = record.vehicleOwnership === 'subcontractor' ? 'รถร่วม' : 'รถบริษัท';
                let allowanceCellHtml;
                if ((record.vehicleOwnership === 'company' || !record.vehicleOwnership) && record.driverAllowance > 0) {
                    const netAllowance = (record.driverAllowance || 0) - 200;
                    allowanceCellHtml = `
                        <div class="flex flex-col items-end">
                            <span>${netAllowance > 0 ? netAllowance.toLocaleString() : '0'}</span>
                            <span class="text-sm text-yellow-400">(สะสม 200)</span>
                        </div>`;
                } else {
                    allowanceCellHtml = formatZeroAsEmpty(record.driverAllowance);
                }

                const isNGV = record.fuelType === 'ngv';
                const fuelAmountCell = isNGV ? '<span class="text-green-400">NGV</span>' : formatZeroAsEmpty(record.totalLiters);
                const fuelCostCell = formatZeroAsEmpty(record.totalBaht);
                const shippingCostCell = isNGV ? '-' : formatZeroAsEmpty(record.shippingCost);
                const fuelTypeDisplay = isNGV ? 'NGV' : 'Diesel';
                
                return `
                <tr class="border-b border-slate-600 hover:bg-slate-700/20">
                    <td class="p-3">${record.date}</td>
                    <td class="p-3 font-mono">${record.vehicleRegistration}</td>
                    <td class="p-3 font-mono">${record.trailerRegistration || '-'}</td>
                    <td class="p-3">${record.driverName || ''}</td>
                    <td class="p-3">${record.vehicleType} (${ownershipText})</td>
                    <td class="p-3">${record.transportCompany || '-'}</td>
                    <td class="p-3">${record.origin} → ${record.destination}</td>
                    <td class="p-3 text-right font-semibold text-accent">${fuelAmountCell}</td>
                    <td class="p-3 text-right font-semibold text-accent">${fuelCostCell}</td>
                    <td class="p-3 text-right font-semibold text-info">${shippingCostCell}</td>
                    <td class="p-3 text-right font-semibold text-success">${allowanceCellHtml}</td>
                    <td class="p-3 text-right">${formatZeroAsEmpty(record.kilometers)}</td>
                    <td class="p-3 text-right">${minutesToHoursAndMinutes(record.travelTime)}</td>
                    <td class="p-3 text-base text-gray-400">${record.details || ''}</td>
                    <td class="p-3 text-base text-gray-400">${record.notes || ''}</td>
                    <td class="p-3">${fuelTypeDisplay}</td>
                </tr>
            `}).join('');

            return renderCard(`
                <h3 class="text-2xl font-bold mb-4">${title}</h3>
                <div class="overflow-x-auto max-h-[600px]">
                    <table class="w-full text-left">
                        <thead class="bg-slate-800 text-base text-gray-400 uppercase sticky top-0 z-10">
                            <tr>
                                <th class="p-3">วันที่</th>
                                <th class="p-3">ทะเบียน</th>
                                <th class="p-3">ทะเบียนหาง</th>
                                <th class="p-3">คนขับ</th>
                                <th class="p-3">ประเภทรถ (สังกัด)</th>
                                <th class="p-3">บริษัทขนส่ง</th>
                                <th class="p-3">เส้นทาง</th>
                                <th class="p-3 text-right">ปริมาณเชื้อเพลิง</th>
                                <th class="p-3 text-right">ค่าเชื้อเพลิง (บาท)</th>
                                <th class="p-3 text-right">ค่าขนส่ง (บาท)</th>
                                <th class="p-3 text-right">เบี้ยขับ (บาท)</th>
                                <th class="p-3 text-right">ระยะทาง (กม.)</th>
                                <th class="p-3 text-right">เวลา (ชม.)</th>
                                <th class="p-3">รายละเอียด</th>
                                <th class="p-3">หมายเหตุ</th>
                                <th class="p-3">ประเภทเชื้อเพลิง</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                    ${records.length === 0 ? '<p class="text-center py-8 text-gray-500">ไม่พบรายการที่ตรงกัน</p>' : ''}
                </div>
            `);
        };

        const renderReportsContent = () => {
            const loadingQueueRecords = getFilteredQueueRecords('loading');
            const unloadingQueueRecords = getFilteredQueueRecords('unloading');

            const exportBtn = document.getElementById('export-reports-excel-btn');
            if (exportBtn) {
                 exportBtn.disabled = loadingQueueRecords.length === 0 && unloadingQueueRecords.length === 0;
            }

            return `
                <div class="space-y-8">
                    ${renderQueueReportTable('รายงานคิวขาขึ้น', loadingQueueRecords)}
                    ${renderQueueReportTable('รายงานคิวถ่าย', unloadingQueueRecords)}
                </div>
            `;
        };

        const renderReports = () => {
            const filters = appState.reportFilters;
            const loadingQueueRecords = getFilteredQueueRecords('loading');
            const unloadingQueueRecords = getFilteredQueueRecords('unloading');

            return `
                 <div class="space-y-8">
                    ${renderCard(`
                        <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                             <h2 class="text-3xl font-bold">ตัวกรองรายงาน</h2>
                            <div class="flex items-center gap-2">
                                <button id="clear-reports-filters-btn" class="flex items-center gap-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                    ${ICONS.Clear} ล้างตัวกรอง
                                </button>
                                <button id="export-reports-excel-btn" ${loadingQueueRecords.length === 0 && unloadingQueueRecords.length === 0 ? 'disabled' : ''} class="flex items-center gap-2 bg-success hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-slate-600 disabled:cursor-not-allowed disabled:transform-none">
                                    ${ICONS.Download} Export to Excel
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="reports-filters">
                            <input name="vehicleRegistration" value="${filters.vehicleRegistration}" placeholder="กรองตามทะเบียนรถ" class="bg-slate-800 border border-slate-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                            <input name="dateFrom" type="date" value="${filters.dateFrom}" class="bg-slate-800 border border-slate-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                            <input name="dateTo" type="date" value="${filters.dateTo}" class="bg-slate-800 border border-slate-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                        </div>
                    `)}

                    <div id="reports-content" class="space-y-8">
                       ${renderReportsContent()}
                    </div>
                </div>
            `;
        };

        const renderStationBreakdown = (route) => {
            const liters = route.gasStationsLiters || {};
            const baht = route.gasStationsBaht || {};
            const allStations = new Set([...Object.keys(liters), ...Object.keys(baht)]);

            if (allStations.size === 0) {
                return `
                    <div class="md:col-span-2">
                        <h4 class="font-bold text-gray-300 mb-2">การกระจายน้ำมัน</h4>
                        <p class="text-base text-gray-500">ไม่มีข้อมูลการเติมน้ำมันสำหรับเส้นทางนี้</p>
                    </div>
                `;
            }

            const stationList = Array.from(allStations).map(key => `
                <div class="flex justify-between">
                    <dt class="text-gray-400">${logisticsService.getFriendlyGasStationName(key)}:</dt>
                    <dd class="font-mono text-right">
                        ${liters[key] ? `<span class="text-accent">${liters[key].toLocaleString()} L</span>` : ''}
                        ${liters[key] && baht[key] ? `<span class="text-gray-500 mx-1">/</span>` : ''}
                        ${baht[key] ? `<span class="text-yellow-400">${baht[key].toLocaleString()} B</span>` : ''}
                    </dd>
                </div>
            `).join('');

            return `
                <div class="md:col-span-2">
                    <h4 class="font-bold text-gray-300 mb-2">การกระจายน้ำมัน</h4>
                    <dl class="space-y-1 text-base">
                        ${stationList}
                    </dl>
                </div>
            `;
        }


        const updateRoutesTableBody = () => {
            let routes = logisticsService.getRoutes();

            // 1. Filtering
            const activeFilters = Object.entries(appState.routeFilters).filter(([, value]) => value);
            if (activeFilters.length > 0) {
                routes = routes.filter(route => {
                    return activeFilters.every(([key, filterValue]) => {
                        const routeValue = route[key];
                        if (filterValue === null || filterValue === '') return true;
                        if (key === 'travelTime') {
                             return (minutesToHoursAndMinutes(routeValue) || '').includes(filterValue);
                        }
                        return (routeValue?.toString().toLowerCase() || '').includes(filterValue.toLowerCase());
                    });
                });
            }

            // 2. Sorting
            const { key: sortKey, direction: sortDirection } = appState.routeSort;
            if (sortKey) {
                const isNumeric = ['driverAllowance', 'kilometers', 'travelTime', 'totalLiters', 'totalBaht', 'shippingCost'].includes(sortKey);
                routes.sort((a, b) => {
                    let valA = a[sortKey] || (isNumeric ? 0 : '');
                    let valB = b[sortKey] || (isNumeric ? 0 : '');
                    if (sortKey === 'origin') { // special sort for combined route
                        valA = `${a.origin} ${a.destination}`;
                        valB = `${b.origin} ${b.destination}`;
                    }
                    let comparison = 0;
                    if (isNumeric) {
                        comparison = valA - valB;
                    } else {
                        comparison = (valA.toString()).localeCompare(valB.toString(), 'th');
                    }
                    return sortDirection === 'asc' ? comparison : -comparison;
                });
            }
            
            const tableBody = document.getElementById('routes-table-body');
            if (!tableBody) return;

            if (routes.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="10" class="text-center py-8 text-gray-500">ไม่พบข้อมูลเส้นทางที่ตรงตามเงื่อนไข</td></tr>`;
                return;
            }

            const tableRows = routes.map(route => {
                const totalLitersText = formatZeroAsEmpty(route.totalLiters);
                const totalBahtText = formatZeroAsEmpty(route.totalBaht);

                const mainRow = `
                <tr key="${route.id}" class="border-b border-slate-700 hover:bg-slate-700/20">
                    <td class="p-2 text-center">
                         <button data-action="toggle-route-details" data-target-id="${route.id}" class="p-2 rounded-full hover:bg-slate-600">
                           ${ICONS.ChevronDown}
                        </button>
                    </td>
                    <td class="p-3 align-top">${route.vehicleType}</td>
                    <td class="p-3 align-top">${route.loadingQueue || '-'}</td>
                    <td class="p-3 align-top">${route.unloadingQueue || '-'}</td>
                    <td class="p-3 align-top">${route.origin} → ${route.destination}</td>
                    <td class="p-3 align-top">${route.transportCompany || '-'}</td>
                    <td class="p-3 text-right align-top">
                        <div class="font-semibold text-accent">${totalLitersText ? `${totalLitersText} L` : ''}</div>
                        <div class="text-base text-yellow-400">${totalBahtText ? `${totalBahtText} B` : ''}</div>
                    </td>
                    <td class="p-3 text-right font-mono align-top">${formatZeroAsEmpty(route.driverAllowance)}</td>
                    <td class="p-3 text-right font-mono align-top">${formatZeroAsEmpty(route.shippingCost)}</td>
                    <td class="p-3 text-center align-top">
                        <div class="flex justify-center items-start gap-2">
                            <button data-action="edit-route" data-id="${route.id}" class="text-blue-400 hover:text-blue-300 p-2 rounded-full transition-colors">${ICONS.Pencil}</button>
                            <button data-action="delete-route" data-id="${route.id}" class="text-red-500 hover:text-red-400 p-2 rounded-full transition-colors">${ICONS.Trash}</button>
                        </div>
                    </td>
                </tr>`;

                const detailsRow = `
                <tr id="details-${route.id}" class="hidden">
                    <td colspan="10" class="p-0 border-b border-slate-700">
                        <div class="bg-slate-900/50 p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <h4 class="font-bold text-gray-300 mb-2">ข้อมูลการเดินทาง</h4>
                                <dl class="space-y-1 text-base">
                                    <div class="flex justify-between">
                                        <dt class="text-gray-400">ระยะทาง:</dt>
                                        <dd class="font-mono">${formatZeroAsEmpty(route.kilometers) || '-'} กม.</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-400">เวลา:</dt>
                                        <dd class="font-mono">${minutesToHoursAndMinutes(route.travelTime) || '-'} ชม.</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-400">คิวขาขึ้น:</dt>
                                        <dd class="font-mono text-right">${route.loadingQueue || '-'}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-400">คิวถ่าย:</dt>
                                        <dd class="font-mono text-right">${route.unloadingQueue || '-'}</dd>
                                    </div>
                                </dl>
                            </div>
                            ${renderStationBreakdown(route)}
                        </div>
                    </td>
                </tr>`;

                return mainRow + detailsRow;
            }).join('');


            tableBody.innerHTML = tableRows;
        };

        const renderDataManagementContent = () => {
            const renderSortableHeader = (key, label, extraClasses = '') => {
                let icon = ICONS.Sort;
                if (appState.routeSort.key === key) {
                    icon = appState.routeSort.direction === 'asc' ? ICONS.SortAsc : ICONS.SortDesc;
                }
                return `<th data-action="sort-routes" data-key="${key}" class="p-3 align-middle cursor-pointer hover:bg-slate-700 ${extraClasses}">
                    <div class="flex items-center gap-2">${label}${icon}</div>
                </th>`;
            };
            
            const renderFilterInput = (key, placeholder = '') => {
                 return `<input type="text" data-filter-key="${key}" value="${appState.routeFilters[key] || ''}" placeholder="${placeholder}" class="w-full bg-slate-800 border-none rounded-sm px-2 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-accent" />`;
            }

            const initialTableBody = `<tr><td colspan="10" class="text-center py-8 text-gray-500">กำลังโหลดข้อมูล...</td></tr>`;

            return renderCard(`
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-800 text-base text-gray-400 uppercase sticky top-0 z-10">
                            <tr>
                                <th class="p-3 w-12"></th>
                                ${renderSortableHeader('vehicleType', 'ประเภทรถ', 'w-32')}
                                ${renderSortableHeader('loadingQueue', 'คิวขาขึ้น', 'w-40')}
                                ${renderSortableHeader('unloadingQueue', 'คิวถ่าย', 'w-40')}
                                ${renderSortableHeader('origin', 'เส้นทาง', 'w-64')}
                                ${renderSortableHeader('transportCompany', 'บริษัทขนส่ง', 'w-40')}
                                <th class="p-3 w-32">รวมน้ำมัน</th>
                                ${renderSortableHeader('driverAllowance', 'เบี้ยขับ (บาท)', 'w-28')}
                                ${renderSortableHeader('shippingCost', 'ค่าขนส่ง (บาท)', 'w-28')}
                                <th class="p-3 w-24 text-center">จัดการ</th>
                            </tr>
                             <tr id="routes-table-filter-row" class="bg-slate-900">
                                <td class="p-1"></td>
                                <td class="p-1">${renderFilterInput('vehicleType')}</td>
                                <td class="p-1">${renderFilterInput('loadingQueue')}</td>
                                <td class="p-1">${renderFilterInput('unloadingQueue')}</td>
                                <td class="p-1">
                                    <div class="flex gap-1">
                                        ${renderFilterInput('origin', 'ต้นทาง...')}
                                        ${renderFilterInput('destination', 'ปลายทาง...')}
                                    </div>
                                </td>
                                <td class="p-1">${renderFilterInput('transportCompany')}</td>
                                <td class="p-1"></td>
                                <td class="p-1">${renderFilterInput('driverAllowance')}</td>
                                <td class="p-1">${renderFilterInput('shippingCost')}</td>
                                <td class="p-1"></td>
                            </tr>
                        </thead>
                        <tbody id="routes-table-body" class="text-base">${initialTableBody}</tbody>
                    </table>
                </div>
            `);
        };

        // --- View: Data Management ---
        const renderDataManagement = () => {
            return `
                <div class="space-y-8">
                    ${renderCard(`
                        <div class="flex flex-wrap justify-between items-center gap-4">
                            <h2 class="text-3xl font-bold text-white flex items-center gap-3">${ICONS.Database}จัดการข้อมูลเส้นทาง</h2>
                            <div class="flex items-center gap-4">
                                <button id="refresh-routes-btn" title="รีเฟรชข้อมูล" class="bg-sky-600 hover:bg-sky-700 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                    ${ICONS.Refresh}
                                </button>
                                <button id="export-routes-excel-btn" class="flex items-center gap-2 bg-success hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                    ${ICONS.Download} Export to Excel
                                </button>
                                <button id="add-new-route-btn" data-action="add-new-route" class="flex items-center gap-2 bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                    ${ICONS.Plus} เพิ่มเส้นทางใหม่
                                </button>
                            </div>
                        </div>
                    `)}
                    <div id="data-management-content">
                        ${renderDataManagementContent()}
                    </div>
                </div>
            `;
        };
        
        const renderVehicleManagementContent = () => {
            const filter = appState.vehicleManagementFilter.toLowerCase();
            const vehicles = logisticsService.getVehicles();
            const filteredVehicles = filter ? vehicles.filter(v => 
                (v.registrationNumber || '').toLowerCase().includes(filter) ||
                (v.vehicleType || '').toLowerCase().includes(filter)
            ) : vehicles;

            const tableRows = filteredVehicles.map(vehicle => `
                <tr key="${vehicle.id}" class="border-b border-slate-600 hover:bg-slate-700/20">
                    <td class="p-3 font-mono">${vehicle.registrationNumber}</td>
                    <td class="p-3">${vehicle.vehicleType}</td>
                    <td class="p-3 text-center">
                        <div class="flex justify-center gap-2">
                            <button data-action="edit-vehicle" data-id="${vehicle.id}" class="text-blue-400 hover:text-blue-300 p-2 rounded-full transition-colors">${ICONS.Pencil}</button>
                            <button data-action="delete-vehicle" data-id="${vehicle.id}" class="text-red-500 hover:text-red-400 p-2 rounded-full transition-colors">${ICONS.Trash}</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            return renderCard(`
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-800 text-base text-gray-400 uppercase">
                            <tr>
                                <th class="p-3">ทะเบียนรถ</th><th class="p-3">ประเภทรถ</th><th class="p-3 text-center">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="vehicles-table-body">${tableRows}</tbody>
                    </table>
                    ${filteredVehicles.length === 0 ? '<p class="text-center py-8 text-gray-500">ไม่พบข้อมูลทะเบียนรถ</p>' : ''}
                </div>
            `);
        };

        // --- View: Vehicle Management ---
        const renderVehicleManagement = () => {
            return `
                <div class="space-y-8">
                    ${renderCard(`
                        <div class="flex flex-wrap justify-between items-center gap-4">
                            <h2 class="text-3xl font-bold text-white flex items-center gap-3">${ICONS.IdCard}จัดการข้อมูลทะเบียนรถ</h2>
                            <div class="flex items-center gap-4">
                                <input type="text" id="vehicle-management-filter" value="${appState.vehicleManagementFilter}" placeholder="ค้นหาทะเบียน/ประเภท..." class="w-full md:w-64 bg-slate-800 border border-slate-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                                 <button id="refresh-vehicles-btn" title="รีเฟรชข้อมูล" class="bg-sky-600 hover:bg-sky-700 text-white font-bold p-2 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                    ${ICONS.Refresh}
                                </button>
                                <button id="add-new-vehicle-btn" data-action="add-new-vehicle" class="flex items-center gap-2 bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                    ${ICONS.Plus} เพิ่มทะเบียนใหม่
                                </button>
                            </div>
                        </div>
                    `)}
                    <div id="vehicle-management-content">
                        ${renderVehicleManagementContent()}
                    </div>
                </div>
            `;
        };

        // --- View: Driver Savings ---
        const getDriverSavingsData = () => {
            const companyRecords = appState.fuelRecords.filter(
                r => (r.vehicleOwnership === 'company' || !r.vehicleOwnership) && r.driverName && r.driverAllowance > 0
            );
            const payouts = appState.savingsPayouts;
            const carryOvers = appState.savingsCarryOvers;
            const savingsByDriver = {};

            // 1. Accumulate savings from trips
            companyRecords.forEach(record => {
                if (!savingsByDriver[record.driverName]) {
                    savingsByDriver[record.driverName] = {
                        driverName: record.driverName,
                        trips: 0,
                        totalFullAllowance: 0,
                        totalSaved: 0,
                        totalPaid: 0,
                    };
                }
                savingsByDriver[record.driverName].trips += 1;
                savingsByDriver[record.driverName].totalFullAllowance += (record.driverAllowance || 0);
                savingsByDriver[record.driverName].totalSaved += 200;
            });

            // 2. Add carry-over amounts to totalSaved
            carryOvers.forEach(co => {
                const driverName = co.driverName;
                if (!savingsByDriver[driverName]) {
                     savingsByDriver[driverName] = { driverName, trips: 0, totalFullAllowance: 0, totalSaved: 0, totalPaid: 0 };
                }
                savingsByDriver[driverName].totalSaved += Number(co.carryOverAmount) || 0;
            });

            // 3. Accumulate paid amounts
            payouts.forEach(payout => {
                const driverName = payout.driverName;
                if (!savingsByDriver[driverName]) {
                     savingsByDriver[driverName] = { driverName, trips: 0, totalFullAllowance: 0, totalSaved: 0, totalPaid: 0 };
                }
                savingsByDriver[driverName].totalPaid += Number(payout.payoutAmount) || 0;
            });
            
            const savingsData = Object.values(savingsByDriver).map(driver => ({
                ...driver,
                netBalance: driver.totalSaved - driver.totalPaid,
            })).sort((a, b) => a.driverName.localeCompare(b.driverName, 'th'));
            return savingsData;
        };

        const renderDriverSavingsContent = () => {
            const savingsData = getDriverSavingsData();

            const tableRows = savingsData.map((driver, index) => `
                <tr class="border-b border-slate-600 hover:bg-slate-700/20">
                    <td class="p-3 text-center">${index + 1}</td>
                    <td class="p-3 font-semibold">${driver.driverName}</td>
                    <td class="p-3 text-center">${driver.trips.toLocaleString()}</td>
                    <td class="p-3 text-right text-green-400">${driver.totalFullAllowance.toLocaleString()}</td>
                    <td class="p-3 text-right text-info">${driver.totalSaved.toLocaleString()}</td>
                    <td class="p-3 text-right text-yellow-400">${driver.totalPaid.toLocaleString()}</td>
                    <td class="p-3 text-right font-bold text-success">${driver.netBalance.toLocaleString()}</td>
                    <td class="p-3 text-center">
                        <button data-action="show-driver-savings-details" data-driver-name="${driver.driverName}" class="bg-sky-600 hover:bg-sky-700 text-white text-sm font-bold py-1 px-3 rounded-md transition">
                            รายละเอียด
                        </button>
                    </td>
                </tr>
            `).join('');

            return renderCard(`
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-800 text-base text-gray-400 uppercase">
                            <tr>
                                <th class="p-3 text-center w-16">#</th>
                                <th class="p-3">ชื่อพนักงานขับรถ</th>
                                <th class="p-3 text-center">จำนวนเที่ยว</th>
                                <th class="p-3 text-right">เบี้ยขับเต็ม (บาท)</th>
                                <th class="p-3 text-right">ยอดรวมเงินสะสม (บาท)</th>
                                <th class="p-3 text-right">ยอดจ่ายแล้ว (บาท)</th>
                                <th class="p-3 text-right">ยอดคงเหลือ (บาท)</th>
                                <th class="p-3 text-center">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${savingsData.length > 0 ? tableRows : `<tr><td colspan="8" class="text-center py-8 text-gray-500">ไม่พบข้อมูลเงินสะสม</td></tr>`}
                        </tbody>
                    </table>
                </div>
            `);
        };

        const renderDriverSavings = () => {
             return `
                <div class="space-y-8">
                    ${renderCard(`
                        <div class="flex flex-wrap justify-between items-center gap-4">
                            <h2 class="text-3xl font-bold text-white flex items-center gap-3">${ICONS.Wallet}รายงานเงินสะสมพนักงานขับรถ (หักเที่ยวละ 200 บาท)</h2>
                            <div class="flex items-center gap-4">
                                <button id="add-new-carryover-btn" data-action="add-new-carryover" class="flex items-center gap-2 bg-success hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                    ${ICONS.Plus} เพิ่มยอดยกมา
                                </button>
                                <button id="add-new-payout-btn" data-action="add-new-payout" class="flex items-center gap-2 bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                    ${ICONS.Plus} บันทึกการจ่ายเงินสะสม
                                </button>
                                <button id="export-savings-excel-btn" class="flex items-center gap-2 bg-success hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                                    ${ICONS.Download} Export to Excel
                                </button>
                            </div>
                        </div>
                    `)}
                    <div id="driver-savings-content">
                        ${renderDriverSavingsContent()}
                    </div>
                </div>
            `;
        }


        // --- Modals ---
        const renderModal = () => `<div id="modal-container" class="hidden"></div>`;
        const renderAuthModal = () => `<div id="auth-modal-container" class="hidden"></div>`;

        const openModal = (title, content, maxWidth = 'max-w-2xl') => {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-70 z-40 flex justify-center items-center">
                    <div class="bg-neutral rounded-xl shadow-2xl w-full ${maxWidth} max-h-[90vh] flex flex-col">
                        <header class="flex justify-between items-center p-4 border-b border-slate-600">
                            <h2 class="text-2xl font-bold text-white">${title}</h2>
                            <button data-action="close-modal" class="text-gray-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </header>
                        <main class="p-6 overflow-y-auto">${content}</main>
                    </div>
                </div>
            `;
            modalContainer.classList.remove('hidden');
        };

        const closeModal = () => {
             document.getElementById('modal-container').classList.add('hidden');
             document.getElementById('auth-modal-container').classList.add('hidden');
        };
        
        const openAuthModal = () => {
             const modalContainer = document.getElementById('auth-modal-container');
             modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-70 z-40 flex justify-center items-center">
                    <div class="bg-neutral rounded-xl shadow-2xl w-full max-w-md">
                        <header class="flex justify-between items-center p-4 border-b border-slate-600">
                            <h2 class="text-2xl font-bold text-white">เข้าสู่หน้าจัดการข้อมูล</h2>
                            <button data-action="close-modal" class="text-gray-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </header>
                        <main class="p-6">
                             <form id="auth-form" class="space-y-4">
                                <div>
                                    <label for="password" class="block text-base font-medium text-gray-400 mb-1">กรุณากรอกรหัสผ่านเพื่อดำเนินการต่อ</label>
                                    <input id="password" type="password" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" autofocus />
                                </div>
                                <p id="auth-error" class="text-sm text-red-400 hidden"></p>
                                <div class="flex justify-end pt-2">
                                    <button type="submit" class="bg-primary hover:bg-secondary text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">ยืนยัน</button>
                                </div>
                            </form>
                        </main>
                    </div>
                </div>
             `;
             modalContainer.classList.remove('hidden');
             const authForm = document.getElementById('auth-form');
             if (authForm) {
                 authForm.addEventListener('submit', handleAuthSubmit);
             }
        }

        const renderRouteFormContent = (route) => {
            const distributionItemsLiters = route?.gasStationsLiters ? Object.entries(route.gasStationsLiters).map(([stationKey, amount]) => ({stationKey, amount})) : [];
            const distributionItemsBaht = route?.gasStationsBaht ? Object.entries(route.gasStationsBaht).map(([stationKey, amount]) => ({stationKey, amount})) : [];
            
             return `
                <form id="route-form" class="space-y-6">
                    <input type="hidden" name="id" value="${route?.id || ''}" />
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">ประเภทรถ</label>
                            <input type="text" name="vehicleType" value="${route?.vehicleType || ''}" placeholder="เช่น, 18 ล้อ" required class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                        </div>
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">บริษัทขนส่ง</label>
                            <input type="text" name="transportCompany" value="${route?.transportCompany || ''}" placeholder="ชื่อบริษัท" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">ต้นทาง</label>
                            <input type="text" name="origin" value="${route?.origin || ''}" placeholder="เช่น, กทม" required class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                        </div>
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">ปลายทาง</label>
                            <input type="text" name="destination" value="${route?.destination || ''}" placeholder="เช่น, เชียงใหม่" required class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">คิวขาขึ้น</label>
                            <input type="text" name="loadingQueue" value="${route?.loadingQueue || ''}" placeholder="รายละเอียดคิวขึ้น" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                        </div>
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">คิวถ่าย</label>
                            <input type="text" name="unloadingQueue" value="${route?.unloadingQueue || ''}" placeholder="รายละเอียดคิวถ่าย" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">ราคาค่าขนส่ง (บาท)</label>
                            <input type="number" name="shippingCost" value="${route?.shippingCost || ''}" placeholder="0" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                        </div>
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">เบี้ยขับ (บาท)</label>
                            <input type="number" name="driverAllowance" value="${route?.driverAllowance || ''}" placeholder="0" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                        </div>
                    </div>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">ระยะทาง (กม.)</label>
                            <input type="number" name="kilometers" value="${route?.kilometers || ''}" placeholder="0" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                        </div>
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">เวลาเดินทาง (ชม.)</label>
                            <input type="text" name="travelTime" value="${minutesToHoursAndMinutes(route?.travelTime)}" placeholder="เช่น 4.30 (4 ชม. 30 นาที)" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                        </div>
                    </div>

                    <div class="space-y-4 rounded-lg border border-slate-600 p-4">
                        <h3 class="font-semibold text-lg text-white">การกระจายน้ำมัน (ลิตร)</h3>
                        <div id="route-distribution-list-liters">
                             ${distributionItemsLiters.map((item, index) => renderRouteDistributionRow(item, index, 'Liters')).join('')}
                        </div>
                        <button type="button" data-action="add-route-distribution" data-unit="Liters" class="w-full border-2 border-dashed border-slate-500 hover:bg-slate-700/50 text-gray-300 font-semibold py-2 px-4 rounded-lg transition">+ เพิ่มจุดเติมน้ำมัน (ลิตร)</button>
                    </div>
                    
                    <div class="space-y-4 rounded-lg border border-slate-600 p-4">
                        <h3 class="font-semibold text-lg text-white">การกระจายน้ำมัน (บาท)</h3>
                        <div id="route-distribution-list-baht">
                             ${distributionItemsBaht.map((item, index) => renderRouteDistributionRow(item, index, 'Baht')).join('')}
                        </div>
                        <button type="button" data-action="add-route-distribution" data-unit="Baht" class="w-full border-2 border-dashed border-slate-500 hover:bg-slate-700/50 text-gray-300 font-semibold py-2 px-4 rounded-lg transition">+ เพิ่มจุดเติมน้ำมัน (บาท)</button>
                    </div>


                    <footer class="flex justify-end gap-4 pt-4">
                        <button type="button" data-action="close-modal" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition">ยกเลิก</button>
                        <button type="submit" class="bg-primary hover:bg-secondary text-white font-bold py-2 px-6 rounded-lg transition">บันทึกข้อมูล</button>
                    </footer>
                </form>
             `;
        };
        
        const renderVehicleFormContent = (vehicle) => {
            return `
                <form id="vehicle-form" class="space-y-6">
                    <input type="hidden" name="id" value="${vehicle?.id || ''}" />
                    <div>
                        <label class="block text-base font-medium text-gray-400 mb-1">ทะเบียนรถ</label>
                        <input type="text" name="registrationNumber" value="${vehicle?.registrationNumber || ''}" placeholder="เช่น, 70-1234" required class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                    </div>
                    <div>
                        <label class="block text-base font-medium text-gray-400 mb-1">ประเภทรถ</label>
                        <input type="text" name="vehicleType" value="${vehicle?.vehicleType || ''}" placeholder="เช่น, 18 ล้อ HINO" required class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent" />
                    </div>
                    <footer class="flex justify-end gap-4 pt-4">
                        <button type="button" data-action="close-modal" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition">ยกเลิก</button>
                        <button type="submit" class="bg-primary hover:bg-secondary text-white font-bold py-2 px-6 rounded-lg transition">บันทึกข้อมูล</button>
                    </footer>
                </form>
            `;
        };

        const renderFuelRecordEditFormContent = (record) => {
            const distributionLiters = record.fuelDistributionLiters ? Object.entries(record.fuelDistributionLiters).map(([stationKey, amount]) => ({ stationKey, amount })) : [];
            const distributionBaht = record.fuelDistributionBaht ? Object.entries(record.fuelDistributionBaht).map(([stationKey, amount]) => ({ stationKey, amount })) : [];
            const transportCompanyOptions = logisticsService.getUniqueValues('transportCompany')
                .map(company => `<option value="${company}" ${record.transportCompany === company ? 'selected' : ''}>${company}</option>`)
                .join('');
            
            const recordRoute = logisticsService.findMatchingRoute(record.vehicleType, record.origin, record.destination, record.transportCompany || '');
            let queueOptionsHtml = '';
            if (recordRoute && record.queueType && record.queueType !== 'none') {
                const queueDataKey = record.queueType === 'loading' ? 'loadingQueue' : 'unloadingQueue';
                const queueDataString = recordRoute[queueDataKey];
                if (queueDataString) {
                    const options = queueDataString.split(',').map(item => item.trim()).filter(item => item);
                    queueOptionsHtml = options.map(opt => `<option value="${opt}" ${record.queueDetails === opt ? 'selected' : ''}>${opt}</option>`).join('');
                }
            }

             return `
                <form id="fuel-record-edit-form" class="space-y-4">
                    <input type="hidden" name="id" value="${record.id}" />
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">วันที่</label>
                            <input type="date" name="date" value="${record.date}" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                        </div>
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">ทะเบียนรถ</label>
                            <input type="text" name="vehicleRegistration" value="${record.vehicleRegistration}" placeholder="เช่น, กข-1234" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                        </div>
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">ทะเบียนหาง</label>
                            <input type="text" name="trailerRegistration" value="${record.trailerRegistration || ''}" placeholder="ทะเบียนส่วนหาง" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                        </div>
                    </div>
                     <div>
                        <label class="block text-base font-medium text-gray-400 mb-1">ชื่อพนักงานขับรถ</label>
                        <input type="text" name="driverName" value="${record.driverName || ''}" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                    </div>
                     <div>
                        <label class="block text-base font-medium text-gray-400 mb-1">ประเภทรถ</label>
                        <input type="text" name="vehicleType" value="${record.vehicleType}" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                    </div>
                     <div>
                        <label class="block text-base font-medium text-gray-400 mb-1">ประเภทรถ (สังกัด)</label>
                        <div class="flex items-center gap-6">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="vehicleOwnership" value="company" ${record.vehicleOwnership === 'company' || !record.vehicleOwnership ? 'checked' : ''} />
                                <span>รถบริษัท</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="vehicleOwnership" value="subcontractor" ${record.vehicleOwnership === 'subcontractor' ? 'checked' : ''} />
                                <span>รถร่วมขนส่ง</span>
                            </label>
                        </div>
                    </div>
                    <div id="edit-subcontractor-details" class="${record.vehicleOwnership === 'subcontractor' ? '' : 'hidden'}">
                        <label class="block text-base font-medium text-gray-400 mb-1">บริษัทขนส่ง <span class="text-red-400">*</span></label>
                        <select name="transportCompany" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white">
                            <option value="">-- กรุณาเลือกบริษัทขนส่ง --</option>
                            ${transportCompanyOptions}
                        </select>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">ต้นทาง</label>
                            <input type="text" name="origin" value="${record.origin}" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                        </div>
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">ปลายทาง</label>
                            <input type="text" name="destination" value="${record.destination}" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">ประเภทคิว</label>
                            <div id="edit-queue-type-radios" class="flex items-center gap-6">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="queueType" value="loading" ${record.queueType === 'loading' ? 'checked' : ''} />
                                    <span>คิวขาขึ้น</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="queueType" value="unloading" ${record.queueType === 'unloading' ? 'checked' : ''} />
                                    <span>คิวถ่าย</span>
                                </label>
                            </div>
                        </div>
                        <div id="edit-queue-details-wrapper" class="${!record.queueType || record.queueType === 'none' ? 'hidden' : ''}">
                            <label class="block text-base font-medium text-gray-400 mb-1">รายละเอียดคิว</label>
                            <select name="queueDetails" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white">
                                <option value="">-- กรุณาเลือก --</option>
                                ${queueOptionsHtml}
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">ค่าขนส่ง (บาท)</label>
                            <input type="number" name="shippingCost" value="${record.shippingCost || ''}" placeholder="0" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                        </div>
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">เบี้ยขับ (บาท)</label>
                            <input type="number" name="driverAllowance" value="${record.driverAllowance || ''}" placeholder="0" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">ระยะทาง (กม.)</label>
                            <input type="number" name="kilometers" value="${record.kilometers || ''}" placeholder="0" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                        </div>
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">เวลาเดินทาง (ชม.)</label>
                            <input type="text" name="travelTime" value="${minutesToHoursAndMinutes(record.travelTime)}" placeholder="เช่น 4.30 (4 ชม. 30 นาที)" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                        </div>
                    </div>

                    <!-- Liters Distribution -->
                    <div class="space-y-4 rounded-lg border border-slate-600 p-4">
                        <h3 class="font-semibold text-lg text-white">การกระจายน้ำมัน (ลิตร)</h3>
                        <div id="edit-distribution-list-liters">
                            ${distributionLiters.map((item, index) => renderRouteDistributionRow(item, index, 'Liters')).join('')}
                        </div>
                        <button type="button" data-action="add-edit-distribution" data-unit="Liters" class="w-full border-2 border-dashed border-slate-500 hover:bg-slate-700/50 text-gray-300 font-semibold py-2 px-4 rounded-lg transition">+ เพิ่มจุดเติมน้ำมัน (ลิตร)</button>
                    </div>

                     <!-- Baht Distribution -->
                    <div class="space-y-4 rounded-lg border border-slate-600 p-4">
                        <h3 class="font-semibold text-lg text-white">การกระจายน้ำมัน (บาท)</h3>
                        <div id="edit-distribution-list-baht">
                            ${distributionBaht.map((item, index) => renderRouteDistributionRow(item, index, 'Baht')).join('')}
                        </div>
                        <button type="button" data-action="add-edit-distribution" data-unit="Baht" class="w-full border-2 border-dashed border-slate-500 hover:bg-slate-700/50 text-gray-300 font-semibold py-2 px-4 rounded-lg transition">+ เพิ่มจุดเติมน้ำมัน (บาท)</button>
                    </div>

                    <div>
                        <label class="block text-base font-medium text-gray-400 mb-1">รายละเอียด</label>
                        <textarea name="details" placeholder="รายละเอียดเพิ่มเติม" rows="3" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white">${record.details || ''}</textarea>
                    </div>
                    
                    <div>
                        <label class="block text-base font-medium text-gray-400 mb-1">หมายเหตุ</label>
                        <textarea name="notes" placeholder="หมายเหตุเพิ่มเติมเกี่ยวกับการเดินทาง" rows="3" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white">${record.notes || ''}</textarea>
                    </div>

                    <footer class="flex justify-end gap-4 pt-4">
                        <button type="button" data-action="close-modal" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition">ยกเลิก</button>
                        <button type="submit" class="bg-primary hover:bg-secondary text-white font-bold py-2 px-6 rounded-lg transition">บันทึกการเปลี่ยนแปลง</button>
                    </footer>
                </form>
             `;
        };
        // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        // 5. EVENT LISTENERS & HANDLERS
        // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        
        let isMainListenerAttached = false;

        const attachEventListeners = () => {
            const container = document.getElementById('app-container');
            if (!container) return;

            // Use event delegation for dynamic elements, but only attach it once.
            if (!isMainListenerAttached) {
                container.addEventListener('click', handleAppClick);
                isMainListenerAttached = true;
            }

            // Attach listeners for specific elements within the current view
            if (appState.view === 'form') {
                attachFormListeners();
            } else if (appState.view === 'dashboard') {
                attachDashboardListeners();
            } else if (appState.view === 'reports') {
                attachReportsListeners();
            } else if (appState.view === 'data') {
                attachDataManagementListeners();
            } else if (appState.view === 'vehicles') {
                attachVehicleManagementListeners();
            } else if (appState.view === 'savings') {
                const exportBtn = document.getElementById('export-savings-excel-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', handleExportSavingsToExcel);
                }
            }
        };

        const handleAppClick = (e) => {
            const target = e.target.closest('[data-action], .nav-button, #add-new-route-btn, #add-new-vehicle-btn, #add-new-payout-btn, #add-new-carryover-btn');
            if (!target) return;

            const action = target.dataset.action;
            const id = target.dataset.id;
            
            // --- Global Actions ---
            if (target.classList.contains('nav-button')) {
                const view = target.dataset.view;
                if (['data', 'vehicles', 'savings', 'reports'].includes(view) && !appState.isAuthenticated) {
                    const pagesNeedingAuth = ['data', 'vehicles', 'savings'];
                    if (pagesNeedingAuth.includes(view)) {
                        openAuthModal();
                        // Store the intended view to navigate to after successful authentication
                        appState.pendingView = view;
                    } else {
                        appState.view = view;
                        renderApp();
                    }
                } else {
                    appState.view = view;
                    renderApp();
                }
            }
            if (action === 'close-modal') closeModal();

            // --- Authentication Actions ---
             if (action === 'auth-confirm') {
                 // Logic handled by form submission
             }
            
            // --- Dashboard Pagination Actions ---
            if (action === 'paginate-prev') {
                if (appState.dashboardFilters.currentPage > 1) {
                    appState.dashboardFilters.currentPage--;
                    document.getElementById('dashboard-content').innerHTML = renderDashboardContent();
                }
            }
            if (action === 'paginate-next') {
                const allFilteredRecords = getFilteredFuelRecords();
                const limit = appState.dashboardFilters.recordLimit;
                const itemsPerPage = (limit === 'all' || !limit) ? allFilteredRecords.length : parseInt(limit, 10);
                const totalPages = itemsPerPage > 0 ? Math.ceil(allFilteredRecords.length / itemsPerPage) : 1;
                if (appState.dashboardFilters.currentPage < totalPages) {
                    appState.dashboardFilters.currentPage++;
                    document.getElementById('dashboard-content').innerHTML = renderDashboardContent();
                }
            }

            // --- Route Actions ---
            if (action === 'add-new-route') handleAddNewRoute();
            if (action === 'edit-route') handleEditRoute(id);
            if (action === 'delete-route') handleDeleteRoute(id);
            if (action === 'add-route-distribution') handleAddRouteDistribution(target);
            if (action === 'sort-routes') handleSortRoutes(target.dataset.key);
            if (action === 'toggle-route-details') {
                const detailsId = `details-${target.dataset.targetId}`;
                const detailsRow = document.getElementById(detailsId);
                const icon = target.querySelector('svg');
                if (detailsRow) {
                    detailsRow.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                }
            }

            // --- Fuel Record Actions ---
            if (action === 'edit-fuel-record') handleEditFuelRecord(id);
            if (action === 'delete-fuel-record') handleDeleteFuelRecord(id);
            if (action === 'add-edit-distribution') handleAddEditDistribution(target);
            if (action === 'toggle-fuel-record-details') {
                const detailsId = `details-fuel-${target.dataset.targetId}`;
                const detailsRow = document.getElementById(detailsId);
                const icon = target.querySelector('svg');
                if (detailsRow) {
                    detailsRow.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                }
            }

             // --- Vehicle Actions ---
            if (action === 'add-new-vehicle') handleAddNewVehicle();
            if (action === 'edit-vehicle') handleEditVehicle(id);
            if (action === 'delete-vehicle') handleDeleteVehicle(id);
            
            // --- Savings Actions ---
            if (action === 'add-new-payout') handleAddNewPayout();
            if (action === 'add-new-carryover') handleAddNewCarryOver();
            if (action === 'show-driver-savings-details') handleShowDriverSavingsDetails(target.dataset.driverName);
            if (action === 'edit-payout') handleEditPayout(id);
            if (action === 'delete-payout') handleDeletePayout(id);
            if (action === 'edit-carryover') handleEditCarryOver(id);
            if (action === 'delete-carryover') handleDeleteCarryOver(id);

            // --- Common Form Actions ---
            if (action === 'remove-distribution') {
                const row = e.target.closest('.distribution-row');
                if (row) row.remove();

                // If in main form, update totals
                if (document.getElementById('fuel-record-form')) {
                    updateTotalAmount('liters');
                    updateTotalAmount('baht');
                }
            }
        };
        
        const attachFormListeners = () => {
            const form = document.getElementById('fuel-record-form');
            if (form) {
                 form.addEventListener('submit', handleFuelFormSubmit);
                 // Delegated listener for ownership and fuel type radios
                 form.addEventListener('change', (e) => {
                    if (e.target.name === 'fuelType') {
                        // Clear values when switching fuel type
                        const isNGV = e.target.value === 'ngv';
                         if (isNGV) {
                            document.getElementById('distribution-list-liters').innerHTML = '';
                            document.getElementById('distribution-list-baht').innerHTML = '';
                            updateTotalAmount('liters');
                            updateTotalAmount('baht');
                            document.getElementById('form-shipping-cost').value = '';
                        } else {
                            document.getElementById('form-ngv-cost').value = '';
                        }
                        updateFuelFormVisibility();
                        updateVlookupCard();
                    } else if (e.target.name === 'vehicleOwnership') {
                        // Clear values when switching ownership
                         const isSubcontractor = e.target.value === 'subcontractor';
                         if (isSubcontractor) {
                            document.getElementById('distribution-list-liters').innerHTML = '';
                            document.getElementById('distribution-list-baht').innerHTML = '';
                            updateTotalAmount('liters');
                            updateTotalAmount('baht');
                            document.getElementById('form-driver-allowance').value = '';
                            document.getElementById('form-kilometers').value = '';
                            document.getElementById('form-travel-time').value = '';
                            // Clear queue fields as they don't apply
                            const queueRadios = document.querySelectorAll('input[name="queueType"]');
                            if (queueRadios) queueRadios.forEach(radio => radio.checked = false);
                            document.getElementById('queue-details-wrapper').classList.add('hidden');
                            const queueDetailsSelect = document.getElementById('form-queue-details');
                            if (queueDetailsSelect) queueDetailsSelect.innerHTML = '';

                        } else {
                            document.getElementById('form-transport-company').value = '';
                            document.getElementById('form-shipping-cost').value = '';
                        }
                        updateFuelFormVisibility();
                        updateVlookupCard();
                    }
                });
            }
            
            const handleVehicleRegistrationSelect = (registrationNumber) => {
                const vehicle = appState.vehicles.find(v => v.registrationNumber === registrationNumber);
                if (vehicle) {
                    const vehicleTypeInput = document.getElementById('form-vehicle-type');
                    if (vehicleTypeInput) {
                        vehicleTypeInput.value = vehicle.vehicleType;
                        // Trigger change to update the vlookup card automatically
                        vehicleTypeInput.dispatchEvent(new Event('change'));
                    }
                }
                
                // New: Auto-populate driver name
                const latestRecord = appState.fuelRecords.find(r => r.vehicleRegistration === registrationNumber);
                const driverNameInput = document.getElementById('form-driver-name');
                if (driverNameInput) {
                    driverNameInput.value = latestRecord?.driverName || '';
                }
            };

            // Autocomplete listeners
            attachAutocompleteListeners('form-vehicle-registration', logisticsService.getVehicleRegistrations(), handleVehicleRegistrationSelect);
            attachAutocompleteListeners('form-vehicle-type', logisticsService.getUniqueValues('vehicleType'));
            attachAutocompleteListeners('form-origin', logisticsService.getUniqueValues('origin'));
            attachAutocompleteListeners('form-destination', logisticsService.getUniqueValues('destination'));

            // V-lookup trigger
            ['form-vehicle-type', 'form-origin', 'form-destination'].forEach(id => {
                const input = document.getElementById(id);
                if(input) input.addEventListener('change', updateVlookupCard);
            });

            const transportCompanySelect = document.getElementById('form-transport-company');
            if (transportCompanySelect) {
                transportCompanySelect.addEventListener('change', updateVlookupCard);
            }
            
            // Also trigger driver name lookup on change (for manual typing)
            const regInput = document.getElementById('form-vehicle-registration');
            if (regInput) regInput.addEventListener('change', (e) => handleVehicleRegistrationSelect(e.target.value));

            // Distribution buttons
            const addLitersBtn = document.getElementById('add-distribution-btn-liters');
            const addBahtBtn = document.getElementById('add-distribution-btn-baht');
            if(addLitersBtn) addLitersBtn.addEventListener('click', () => updateDistributionList('liters'));
            if(addBahtBtn) addBahtBtn.addEventListener('click', () => updateDistributionList('baht'));
            
            // Reset button
            const resetBtn = document.getElementById('reset-fuel-form-btn');
            if(resetBtn) resetBtn.addEventListener('click', resetFuelForm);

            // Recalculate totals on change
            document.getElementById('distribution-list-liters')?.addEventListener('input', () => updateTotalAmount('liters'));
            document.getElementById('distribution-list-baht')?.addEventListener('input', () => updateTotalAmount('baht'));
            
            // Queue Type listener
            const queueRadios = document.getElementById('queue-type-radios');
            if (queueRadios) {
                queueRadios.addEventListener('change', () => {
                    updateQueueDetailsDropdown();
                    const queueDetailsSelect = document.getElementById('form-queue-details');
                    if (queueDetailsSelect) queueDetailsSelect.value = '';
                    updateVlookupCard();
                });
            }

            // Queue Details listener
            const queueDetailsSelect = document.getElementById('form-queue-details');
            if (queueDetailsSelect) {
                queueDetailsSelect.addEventListener('change', updateVlookupCard);
            }

            // Initial UI state setup
            updateFuelFormVisibility();
            updateVlookupCard();
        };

        const attachDashboardListeners = () => {
            const filters = document.getElementById('dashboard-filters');
            if(filters) {
                filters.addEventListener('input', (e) => {
                    const { name, value } = e.target;
                    appState.dashboardFilters[name] = value;
                    appState.dashboardFilters.currentPage = 1;
                    const content = document.getElementById('dashboard-content');
                    if (content) content.innerHTML = renderDashboardContent();
                });
            }

            const limitSelect = document.getElementById('record-limit-select');
            if (limitSelect) {
                limitSelect.addEventListener('change', (e) => {
                    appState.dashboardFilters.recordLimit = e.target.value === 'all' ? 'all' : parseInt(e.target.value, 10);
                    appState.dashboardFilters.currentPage = 1;
                    const content = document.getElementById('dashboard-content');
                    if (content) content.innerHTML = renderDashboardContent();
                });
            }

            const clearBtn = document.getElementById('clear-dashboard-filters-btn');
            if(clearBtn) {
                 clearBtn.addEventListener('click', () => {
                    appState.dashboardFilters = { vehicleRegistration: '', dateFrom: '', dateTo: '', recordLimit: 50, currentPage: 1 };
                    renderApp();
                });
            }
            const refreshBtn = document.getElementById('refresh-dashboard-btn');
            if(refreshBtn) {
                refreshBtn.addEventListener('click', () => renderApp());
            }
            const exportBtn = document.getElementById('export-excel-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', handleExportToExcel);
            }
        };

        const attachReportsListeners = () => {
            const filters = document.getElementById('reports-filters');
            if (filters) {
                filters.addEventListener('input', (e) => {
                    const { name, value } = e.target;
                    appState.reportFilters[name] = value;
                    const content = document.getElementById('reports-content');
                    if (content) content.innerHTML = renderReportsContent();
                });
            }

            const clearBtn = document.getElementById('clear-reports-filters-btn');
            if (clearBtn) {
                 clearBtn.addEventListener('click', () => {
                    appState.reportFilters = { vehicleRegistration: '', dateFrom: '', dateTo: '' };
                    renderApp();
                });
            }

            const exportBtn = document.getElementById('export-reports-excel-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', handleExportQueueReportsToExcel);
            }
        };
        
        const attachDataManagementListeners = () => {
            // Initial population of the table body
            updateRoutesTableBody(); 
            
            const filterRow = document.getElementById('routes-table-filter-row');
            if (filterRow) {
                const debouncedUpdate = debounce(updateRoutesTableBody, 300);
                filterRow.addEventListener('input', (e) => {
                    const target = e.target;
                    const key = target.dataset.filterKey;
                    if (key) {
                        appState.routeFilters[key] = target.value;
                        debouncedUpdate();
                    }
                });
            }

            const refreshBtn = document.getElementById('refresh-routes-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', updateRoutesTableBody);
            }

            const exportBtn = document.getElementById('export-routes-excel-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', handleExportRoutesToExcel);
            }
        };

        const handleSortRoutes = (key) => {
            if (!key) return;
            const currentSort = appState.routeSort;

            if (currentSort.key === key) {
                if (currentSort.direction === 'asc') {
                    appState.routeSort.direction = 'desc';
                } else {
                    appState.routeSort = { key: 'vehicleType', direction: 'asc' };
                }
            } else {
                appState.routeSort = { key, direction: 'asc' };
            }
            // After changing sort state, we need to update the UI
            const content = document.getElementById('data-management-content');
            if(content) {
                // We need to re-render the headers to show the new sort icon state, then update the body
                content.innerHTML = renderDataManagementContent();
                updateRoutesTableBody();
            }
        };


         const attachVehicleManagementListeners = () => {
            const filterInput = document.getElementById('vehicle-management-filter');
            if (filterInput) {
                filterInput.addEventListener('input', (e) => {
                    appState.vehicleManagementFilter = e.target.value;
                    const content = document.getElementById('vehicle-management-content');
                    if(content) content.innerHTML = renderVehicleManagementContent();
                });
            }
             const refreshBtn = document.getElementById('refresh-vehicles-btn');
            if(refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    const content = document.getElementById('vehicle-management-content');
                    if(content) content.innerHTML = renderVehicleManagementContent();
                });
            }
        };
        
        const attachAutocompleteListeners = (id, options, onSelect) => {
            const input = document.getElementById(id);
            const suggestionsContainer = document.getElementById(`${id}-suggestions`);
            if (!input || !suggestionsContainer) return;

            const showSuggestions = () => {
                const value = input.value.toLowerCase();
                const filteredOptions = options.filter(opt => opt.toLowerCase().includes(value));

                if (filteredOptions.length > 0) {
                    suggestionsContainer.innerHTML = filteredOptions
                        .map(opt => `<div class="p-2 cursor-pointer hover:bg-slate-700">${opt}</div>`)
                        .join('');
                    suggestionsContainer.classList.remove('hidden');
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            };

            input.addEventListener('input', showSuggestions);
            input.addEventListener('focus', showSuggestions);

            suggestionsContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'DIV') {
                    const selectedValue = e.target.textContent;
                    input.value = selectedValue;
                    suggestionsContainer.classList.add('hidden');
                    
                    if (onSelect) {
                        onSelect(selectedValue);
                    }
                    
                    // Trigger change event for vlookup
                    input.dispatchEvent(new Event('change'));
                }
            });

            document.addEventListener('click', (e) => {
                if (e.target.closest('.autocomplete-container') !== input.parentElement) {
                    suggestionsContainer.classList.add('hidden');
                }
            });
        };
        
        const updateQueueDetailsDropdown = () => {
            const queueType = document.querySelector('input[name="queueType"]:checked')?.value;
            const wrapper = document.getElementById('queue-details-wrapper');
            const select = document.getElementById('form-queue-details');

            if (!queueType || queueType === 'none' || !wrapper || !select) {
                wrapper.classList.add('hidden');
                select.innerHTML = '';
                return;
            }

            const queueDataKey = queueType === 'loading' ? 'loadingQueue' : 'unloadingQueue';
            const options = logisticsService.getUniqueCommaSeparatedValues(queueDataKey);

            if (options.length > 0) {
                 select.innerHTML = `<option value="">-- กรุณาเลือก --</option>` + options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                 wrapper.classList.remove('hidden');
            } else {
                 wrapper.classList.add('hidden');
                 select.innerHTML = '';
            }
        };

        const updateVlookupCard = () => {
            const cardContent = document.getElementById('vlookup-card-content');
            if (!cardContent) return;

            const vehicleType = document.getElementById('form-vehicle-type')?.value;
            const origin = document.getElementById('form-origin')?.value;
            const destination = document.getElementById('form-destination')?.value;
            const vehicleOwnership = document.querySelector('input[name="vehicleOwnership"]:checked')?.value;
            const selectedTransportCompany = document.getElementById('form-transport-company')?.value;
            const isNGV = document.querySelector('input[name="fuelType"]:checked')?.value === 'ngv';
            
            const isSubcontractor = vehicleOwnership === 'subcontractor';
            const companyForLookup = isSubcontractor ? selectedTransportCompany : '';

            // Pass queue details only for company vehicles
            const queueType = !isSubcontractor ? document.querySelector('input[name="queueType"]:checked')?.value : null;
            const queueDetails = !isSubcontractor ? document.getElementById('form-queue-details')?.value : null;
            
            // Auto-populate form logic
            const distributionListLiters = document.getElementById('distribution-list-liters');
            const distributionListBaht = document.getElementById('distribution-list-baht');
            const driverAllowanceInput = document.getElementById('form-driver-allowance');
            const kilometersInput = document.getElementById('form-kilometers');
            const travelTimeInput = document.getElementById('form-travel-time');
            const shippingCostInput = document.getElementById('form-shipping-cost');
            
            if(distributionListLiters) distributionListLiters.innerHTML = '';
            if(distributionListBaht) distributionListBaht.innerHTML = '';
            if(driverAllowanceInput) driverAllowanceInput.value = '';
            if(kilometersInput) kilometersInput.value = '';
            if(travelTimeInput) travelTimeInput.value = '';
            if(shippingCostInput) shippingCostInput.value = '';

            // Conditional V-lookup display for company vehicles based on queue selection
            if (vehicleOwnership === 'company') {
                if (!queueType) {
                    updateTotalAmount('liters');
                    updateTotalAmount('baht');
                    cardContent.innerHTML = `
                        <h3 class="text-2xl font-bold text-white mb-4">ข้อมูลเส้นทาง (อัตโนมัติ)</h3>
                        <p class="text-gray-400">กรุณาเลือก "ประเภทคิว" ก่อน เพื่อค้นหาข้อมูลเส้นทาง</p>
                    `;
                    return;
                }
                if (!queueDetails) {
                    updateTotalAmount('liters');
                    updateTotalAmount('baht');
                    cardContent.innerHTML = `
                        <h3 class="text-2xl font-bold text-white mb-4">ข้อมูลเส้นทาง (อัตโนมัติ)</h3>
                        <p class="text-gray-400">กรุณาเลือก "รายละเอียดคิว" เพื่อค้นหาข้อมูลเส้นทาง</p>
                    `;
                    return;
                }
            }
            
            const route = logisticsService.findMatchingRoute(vehicleType, origin, destination, companyForLookup, queueType, queueDetails);

            if (route) {
                if (distributionListLiters && route.gasStationsLiters) {
                    Object.entries(route.gasStationsLiters).forEach(([stationKey, amount], index) => {
                        const newItemHtml = renderRouteDistributionRow({ stationKey, amount }, index, 'Liters', true);
                        distributionListLiters.insertAdjacentHTML('beforeend', newItemHtml);
                    });
                }
                if (distributionListBaht && route.gasStationsBaht) {
                    Object.entries(route.gasStationsBaht).forEach(([stationKey, amount], index) => {
                        const newItemHtml = renderRouteDistributionRow({ stationKey, amount }, index, 'Baht', true);
                        distributionListBaht.insertAdjacentHTML('beforeend', newItemHtml);
                    });
                }
                if (driverAllowanceInput) driverAllowanceInput.value = route.driverAllowance || '';
                if (kilometersInput) kilometersInput.value = route.kilometers || '';
                if (travelTimeInput) travelTimeInput.value = route.travelTime ? minutesToHoursAndMinutes(route.travelTime) : '';
                if (shippingCostInput) shippingCostInput.value = route.shippingCost || '';
            }
            
            updateTotalAmount('liters');
            updateTotalAmount('baht');

            if (!route) {
                cardContent.innerHTML = `
                    <h3 class="text-2xl font-bold text-white mb-4">ข้อมูลเส้นทาง (อัตโนมัติ)</h3>
                    <p class="text-gray-400">ไม่พบข้อมูลเส้นทางที่ตรงกัน</p>
                    <p class="text-base text-gray-500 mt-2">กรุณากรอกข้อมูลและเลือกเงื่อนไขให้ครบถ้วน ${isSubcontractor ? '' : '(รวมถึงประเภทและรายละเอียดคิว)'}</p>
                `;
                return;
            }
            
            const stationList = (stations) => {
                if (!stations || Object.keys(stations).length === 0) return '<p class="text-base text-gray-500">ไม่มี</p>';
                return Object.entries(stations)
                    .map(([key, value]) => `
                        <div class="flex justify-between items-center text-base py-1">
                           <span class="text-gray-400">${logisticsService.getFriendlyGasStationName(key)}:</span>
                           <span class="font-semibold">${value.toLocaleString()}</span>
                        </div>
                    `).join('');
            };

            const vlookupLitersBlock = `
                <div class="flex justify-between items-center text-xl">
                    <span class="font-bold text-accent">รวม (ลิตร):</span>
                    <span class="font-bold text-accent">${(route.totalLiters || 0).toLocaleString()}</span>
                </div>
                ${stationList(route.gasStationsLiters)}
                <hr class="border-slate-600 my-2">
            `;

            const vlookupBahtBlock = `
                <div class="flex justify-between items-center text-xl">
                    <span class="font-bold text-accent">รวม (บาท):</span>
                    <span class="font-bold text-accent">${(route.totalBaht || 0).toLocaleString()}</span>
                </div>
                ${stationList(route.gasStationsBaht)}
            `;

            cardContent.innerHTML = `
                <h3 class="text-2xl font-bold text-white mb-4">ข้อมูลเส้นทาง (อัตโนมัติ)</h3>
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-300">ประเภทรถ:</span>
                        <span>${route.vehicleType}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-gray-300">เส้นทาง:</span>
                        <span class="text-right">${route.origin} → ${route.destination}</span>
                    </div>
                     <hr class="border-slate-600 my-2">
                    <div class="flex justify-between items-center text-base">
                        <span class="text-gray-400">บริษัทขนส่ง:</span>
                        <span class="font-semibold">${route.transportCompany || '-'}</span>
                    </div>
                    <div class="flex justify-between items-center text-base">
                        <span class="text-gray-400">ราคาค่าขนส่ง:</span>
                        <span class="font-semibold">${(route.shippingCost || 0).toLocaleString()} บาท</span>
                    </div>
                    <div class="flex justify-between items-center text-base">
                        <span class="text-gray-400">ระยะทาง:</span>
                        <span class="font-semibold">${(route.kilometers || 0).toLocaleString()} กม.</span>
                    </div>
                    <div class="flex justify-between items-center text-base">
                        <span class="text-gray-400">เวลาเดินทาง:</span>
                        <span class="font-semibold">${minutesToHoursAndMinutes(route.travelTime) || '0.00'} ชม.</span>
                    </div>
                    <div class="flex justify-between items-center text-base">
                        <span class="text-gray-400">คิวขาขึ้น:</span>
                        <span class="font-semibold">${route.loadingQueue || '-'}</span>
                    </div>
                    <div class="flex justify-between items-center text-base">
                        <span class="text-gray-400">คิวถ่าย:</span>
                        <span class="font-semibold">${route.unloadingQueue || '-'}</span>
                    </div>
                    <hr class="border-slate-600 my-2">
                    
                    ${isNGV ? '' : vlookupLitersBlock}
                    ${isNGV ? '' : vlookupBahtBlock}

                    <div class="flex justify-between items-center text-xl pt-2">
                        <span class="font-bold text-success">เบี้ยขับ (บาท):</span>
                        <span class="font-bold text-success">${(route.driverAllowance || 0).toLocaleString()}</span>
                    </div>
                </div>
            `;
        };
        
        const updateDistributionList = (unit) => {
            const unitUpper = unit.charAt(0).toUpperCase() + unit.slice(1); // Liters or Baht
            const container = document.getElementById(`distribution-list-${unit}`);
            if (!container) return;
            
            const index = container.children.length;
            const newItemHtml = renderRouteDistributionRow({}, index, unitUpper);
            container.insertAdjacentHTML('beforeend', newItemHtml);
        };
        
        const updateTotalAmount = (unit) => {
            const container = document.getElementById(`distribution-list-${unit}`);
            const totalInput = document.getElementById(`form-total-${unit}`);
            if (!container || !totalInput) return;

            const rows = container.querySelectorAll('.distribution-row');
            let total = 0;
            rows.forEach(row => {
                const amountInput = row.querySelector('input[type="number"]');
                if (amountInput) {
                    total += Number(amountInput.value) || 0;
                }
            });
            totalInput.value = total > 0 ? total : '';
        };

        const resetFuelForm = () => {
            const form = document.getElementById('fuel-record-form');
            if (form) {
                form.reset();
                // Also reset date to today and clear dynamic lists
                document.getElementById('form-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('distribution-list-liters').innerHTML = '';
                document.getElementById('distribution-list-baht').innerHTML = '';
                document.getElementById('form-trailer-registration').value = '';
                document.getElementById('form-total-liters').value = '';
                document.getElementById('form-total-baht').value = '';
                document.getElementById('form-driver-allowance').value = '';
                document.getElementById('form-shipping-cost').value = '';
                document.getElementById('form-kilometers').value = '';
                document.getElementById('form-travel-time').value = '';
                document.getElementById('form-driver-name').value = '';
                document.querySelector('input[name="fuelType"][value="diesel"]').checked = true;
                document.getElementById('form-ngv-cost').value = '';
                
                // Reset queue fields
                const queueRadios = document.querySelectorAll('input[name="queueType"]');
                if(queueRadios) queueRadios.forEach(radio => radio.checked = false);
                document.getElementById('queue-details-wrapper').classList.add('hidden');
                document.getElementById('form-queue-details').innerHTML = '';

                // Reset conditional UI
                updateFuelFormVisibility();
                updateVlookupCard();

                const status = document.getElementById('form-status');
                if (status) status.innerHTML = '';
            }
        };
        
        const handleFuelFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const statusDiv = document.getElementById('form-status');

            const getDistributionData = (unit) => {
                const container = document.getElementById(`distribution-list-${unit}`);
                if (!container) return {};
                const data = {};
                container.querySelectorAll('.distribution-row').forEach(row => {
                    const stationKey = row.querySelector('select')?.value;
                    const amount = Number(row.querySelector('input[type="number"]')?.value) || 0;
                    if (stationKey && amount > 0) {
                        data[stationKey] = (data[stationKey] || 0) + amount;
                    }
                });
                return data;
            };

            const vehicleType = form.querySelector('#form-vehicle-type').value;
            const origin = form.querySelector('#form-origin').value;
            const destination = form.querySelector('#form-destination').value;
            const travelTimeString = form.querySelector('#form-travel-time').value;
            const vehicleOwnership = form.querySelector('input[name="vehicleOwnership"]:checked').value;
            const transportCompany = form.querySelector('#form-transport-company').value;
            const fuelType = form.querySelector('input[name="fuelType"]:checked').value;
            const isNGV = fuelType === 'ngv';
            const queueTypeInput = form.querySelector('input[name="queueType"]:checked');
            
            if (vehicleOwnership === 'subcontractor' && !transportCompany) {
                 statusDiv.innerHTML = `<p class="text-red-400">สำหรับรถร่วมขนส่ง กรุณาเลือกบริษัทขนส่ง</p>`;
                return;
            }
            
            if (vehicleOwnership === 'company' && !queueTypeInput) {
                statusDiv.innerHTML = `<p class="text-red-400">สำหรับรถบริษัท กรุณาเลือกประเภทคิว</p>`;
                return;
            }

            const totalBahtValue = isNGV 
                ? (Number(form.querySelector('#form-ngv-cost').value) || 0)
                : (Number(form.querySelector('#form-total-baht').value) || 0);

            const record = {
                date: form.querySelector('#form-date').value,
                vehicleRegistration: form.querySelector('#form-vehicle-registration').value,
                trailerRegistration: form.querySelector('#form-trailer-registration').value,
                driverName: form.querySelector('#form-driver-name').value,
                vehicleType: vehicleType,
                vehicleOwnership: vehicleOwnership,
                transportCompany: vehicleOwnership === 'subcontractor' ? transportCompany : '',
                origin: origin,
                destination: destination,
                details: form.querySelector('#form-details').value,
                notes: form.querySelector('#form-notes').value,
                fuelType: fuelType,
                fuelDistributionLiters: !isNGV ? getDistributionData('liters') : {},
                totalLiters: !isNGV ? (Number(form.querySelector('#form-total-liters').value) || 0) : 0,
                fuelDistributionBaht: !isNGV ? getDistributionData('baht') : {},
                totalBaht: totalBahtValue,
                shippingCost: !isNGV && vehicleOwnership === 'subcontractor' ? (Number(form.querySelector('#form-shipping-cost').value) || 0) : 0,
                driverAllowance: Number(form.querySelector('#form-driver-allowance').value) || 0,
                kilometers: Number(form.querySelector('#form-kilometers').value) || 0,
                travelTime: hoursAndMinutesToMinutes(travelTimeString),
                queueType: queueTypeInput ? queueTypeInput.value : 'none',
                queueDetails: form.querySelector('#form-queue-details').value,
            };

            if (!record.date || !record.vehicleRegistration || !record.vehicleType || !record.origin || !record.destination) {
                statusDiv.innerHTML = `<p class="text-red-400">กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน (วันที่, ทะเบียน, ประเภทรถ, เส้นทาง)</p>`;
                return;
            }

            try {
                await logisticsService.addFuelRecord(record);
                statusDiv.innerHTML = `<p class="text-green-400">บันทึกข้อมูลสำเร็จ!</p>`;
                resetFuelForm();
                setTimeout(() => statusDiv.innerHTML = '', 3000);
            } catch (error) {
                console.error("Error saving fuel record:", error);
                statusDiv.innerHTML = `<p class="text-red-400">เกิดข้อผิดพลาดในการบันทึก: ${error.message}</p>`;
            }
        };

        const handleAuthSubmit = (e) => {
            e.preventDefault();
            const passwordInput = document.getElementById('password');
            const errorP = document.getElementById('auth-error');
            // Simple password check, in a real app this would be more secure.
            if (passwordInput.value === "1234") {
                appState.isAuthenticated = true;
                closeModal();
                if (appState.pendingView) {
                    appState.view = appState.pendingView;
                    appState.pendingView = null;
                    renderApp();
                }
            } else {
                errorP.textContent = "รหัสผ่านไม่ถูกต้อง";
                errorP.classList.remove('hidden');
                passwordInput.focus();
            }
        };

        const handleAddNewRoute = () => {
            openModal('เพิ่มเส้นทางใหม่', renderRouteFormContent(), 'max-w-4xl');
            document.getElementById('route-form').addEventListener('submit', handleRouteFormSubmit);
        };

        const handleEditRoute = (id) => {
            const route = logisticsService.getRoutes().find(r => r.id === id);
            if (!route) return;
            openModal('แก้ไขข้อมูลเส้นทาง', renderRouteFormContent(route), 'max-w-4xl');
            document.getElementById('route-form').addEventListener('submit', handleRouteFormSubmit);
        };
        
        const handleDeleteRoute = async (id) => {
            if (confirm('คุณต้องการลบข้อมูลเส้นทางนี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้')) {
                try {
                    await logisticsService.deleteRoute(id);
                } catch (error) {
                    // Error is already handled by an alert in the service layer
                    console.error("Failed to delete route:", error);
                }
            }
        };

        const handleDeleteFuelRecord = async (id) => {
            if (confirm('คุณต้องการลบรายการน้ำมันนี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้')) {
                try {
                    await logisticsService.deleteFuelRecord(id);
                } catch (error) {
                    // Error is already handled by an alert in the service layer
                    console.error("Failed to delete fuel record:", error);
                }
            }
        };

        const handleRouteFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const id = formData.get('id');

            const getDistributionData = (unit) => {
                const container = form.querySelector(`#route-distribution-list-${unit.toLowerCase()}`);
                if (!container) return {};
                const data = {};
                 container.querySelectorAll('.distribution-row').forEach(row => {
                    const stationKey = row.querySelector('[data-field="stationKey"]').value;
                    const amount = Number(row.querySelector('[data-field="amount"]').value) || 0;
                    if (stationKey && amount > 0) {
                        data[stationKey] = (data[stationKey] || 0) + amount;
                    }
                });
                return data;
            };

            const route = {
                vehicleType: formData.get('vehicleType'),
                origin: formData.get('origin'),
                destination: formData.get('destination'),
                transportCompany: formData.get('transportCompany'),
                shippingCost: Number(formData.get('shippingCost')) || 0,
                driverAllowance: Number(formData.get('driverAllowance')) || 0,
                kilometers: Number(formData.get('kilometers')) || 0,
                travelTime: hoursAndMinutesToMinutes(formData.get('travelTime')),
                loadingQueue: formData.get('loadingQueue'),
                unloadingQueue: formData.get('unloadingQueue'),
                gasStationsLiters: getDistributionData('Liters'),
                gasStationsBaht: getDistributionData('Baht'),
            };

            route.totalLiters = Object.values(route.gasStationsLiters).reduce((sum, val) => sum + Number(val), 0);
            route.totalBaht = Object.values(route.gasStationsBaht).reduce((sum, val) => sum + Number(val), 0);

            try {
                const promise = id 
                    ? logisticsService.updateRoute({ id, ...route }) 
                    : logisticsService.addRoute(route);
                await promise;
                closeModal();
            } catch (error) {
                console.error("Error saving route:", error);
                alert("เกิดข้อผิดพลาดในการบันทึกข้อมูลเส้นทาง: " + error.message);
            }
        };

        const handleAddRouteDistribution = (target) => {
            const unit = target.dataset.unit; // 'Liters' or 'Baht'
            const container = document.getElementById(`route-distribution-list-${unit.toLowerCase()}`);
            if (!container) return;
            const index = container.children.length;
            const newRowHtml = renderRouteDistributionRow({}, index, unit);
            container.insertAdjacentHTML('beforeend', newRowHtml);
        };

        const handleEditFuelRecord = (id) => {
            const record = logisticsService.getFuelRecords().find(r => r.id === id);
            if (!record) return;
            openModal('แก้ไขรายการน้ำมัน', renderFuelRecordEditFormContent(record), 'max-w-4xl');
            const form = document.getElementById('fuel-record-edit-form');
            if (form) {
                form.addEventListener('submit', handleFuelRecordEditFormSubmit);

                form.querySelectorAll('input[name="vehicleOwnership"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const subcontractorDetails = form.querySelector('#edit-subcontractor-details');
                        subcontractorDetails.classList.toggle('hidden', e.target.value !== 'subcontractor');
                    });
                });

                form.querySelectorAll('input[name="queueType"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const wrapper = form.querySelector('#edit-queue-details-wrapper');
                        const select = form.querySelector('select[name="queueDetails"]');
                        const queueType = e.target.value;
                        const record = logisticsService.getFuelRecords().find(r => r.id === id);
                        const route = logisticsService.findMatchingRoute(record.vehicleType, record.origin, record.destination, record.transportCompany || '');

                        if (queueType === 'none' || !route) {
                            wrapper.classList.add('hidden');
                            select.innerHTML = '';
                            return;
                        }
                        
                        const queueDataKey = queueType === 'loading' ? 'loadingQueue' : 'unloadingQueue';
                        const queueDataString = route[queueDataKey];
                        
                        if (queueDataString) {
                            const options = queueDataString.split(',').map(item => item.trim()).filter(item => item);
                            if (options.length > 0) {
                                select.innerHTML = `<option value="">-- กรุณาเลือก --</option>` + options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                                wrapper.classList.remove('hidden');
                            } else {
                                 wrapper.classList.add('hidden');
                                 select.innerHTML = '';
                            }
                        } else {
                             wrapper.classList.add('hidden');
                             select.innerHTML = '';
                        }
                    });
                });
            }
        };
        
        const handleFuelRecordEditFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const id = formData.get('id');

            const getDistributionData = (unit) => {
                const container = form.querySelector(`#edit-distribution-list-${unit.toLowerCase()}`);
                if (!container) return {};
                const data = {};
                container.querySelectorAll('.distribution-row').forEach(row => {
                    const stationKey = row.querySelector('select')?.value;
                    const amount = Number(row.querySelector('input[type="number"]')?.value) || 0;
                    if (stationKey && amount > 0) {
                        data[stationKey] = (data[stationKey] || 0) + amount;
                    }
                });
                return data;
            };

            const vehicleOwnership = formData.get('vehicleOwnership');
            const transportCompany = formData.get('transportCompany');

            if (vehicleOwnership === 'subcontractor' && !transportCompany) {
                alert("สำหรับรถร่วมขนส่ง กรุณาเลือกบริษัทขนส่ง");
                return;
            }

            const updatedRecord = {
                id,
                date: formData.get('date'),
                vehicleRegistration: formData.get('vehicleRegistration'),
                trailerRegistration: formData.get('trailerRegistration'),
                driverName: formData.get('driverName'),
                vehicleType: formData.get('vehicleType'),
                vehicleOwnership: vehicleOwnership,
                transportCompany: vehicleOwnership === 'subcontractor' ? transportCompany : '',
                origin: formData.get('origin'),
                destination: formData.get('destination'),
                details: formData.get('details'),
                notes: formData.get('notes'),
                fuelDistributionLiters: getDistributionData('Liters'),
                fuelDistributionBaht: getDistributionData('Baht'),
                shippingCost: Number(formData.get('shippingCost')) || 0,
                driverAllowance: Number(formData.get('driverAllowance')) || 0,
                kilometers: Number(formData.get('kilometers')) || 0,
                travelTime: hoursAndMinutesToMinutes(formData.get('travelTime')),
                queueType: formData.get('queueType'),
                queueDetails: formData.get('queueDetails'),
            };

            updatedRecord.totalLiters = Object.values(updatedRecord.fuelDistributionLiters).reduce((sum, val) => sum + Number(val), 0);
            updatedRecord.totalBaht = Object.values(updatedRecord.fuelDistributionBaht).reduce((sum, val) => sum + Number(val), 0);

            try {
                await logisticsService.updateFuelRecord(updatedRecord);
                closeModal();
            } catch (error) {
                console.error("Error updating fuel record:", error);
                alert("เกิดข้อผิดพลาดในการอัปตเดตข้อมูล: " + error.message);
            }
        };

        const handleAddEditDistribution = (target) => {
            const unit = target.dataset.unit; // 'Liters' or 'Baht'
            const container = document.getElementById(`edit-distribution-list-${unit.toLowerCase()}`);
            if (!container) return;
            const index = container.children.length;
            const newRowHtml = renderRouteDistributionRow({}, index, unit);
            container.insertAdjacentHTML('beforeend', newRowHtml);
        };
        
        const handleAddNewVehicle = () => {
            openModal('เพิ่มทะเบียนรถใหม่', renderVehicleFormContent());
            document.getElementById('vehicle-form').addEventListener('submit', handleVehicleFormSubmit);
        };

        const handleEditVehicle = (id) => {
            const vehicle = logisticsService.getVehicles().find(v => v.id === id);
            if (!vehicle) return;
            openModal('แก้ไขข้อมูลทะเบียนรถ', renderVehicleFormContent(vehicle));
            document.getElementById('vehicle-form').addEventListener('submit', handleVehicleFormSubmit);
        };

        const handleDeleteVehicle = async (id) => {
            if (confirm('คุณต้องการลบข้อมูลทะเบียนรถนี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้')) {
                try {
                    await logisticsService.deleteVehicle(id);
                } catch (error) {
                    console.error("Failed to delete vehicle:", error);
                }
            }
        };

        const handleVehicleFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const id = formData.get('id');
            const vehicleData = {
                registrationNumber: formData.get('registrationNumber'),
                vehicleType: formData.get('vehicleType'),
            };

            if (!vehicleData.registrationNumber || !vehicleData.vehicleType) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            try {
                const promise = id 
                    ? logisticsService.updateVehicle({ id, ...vehicleData }) 
                    : logisticsService.addVehicle(vehicleData);
                await promise;
                closeModal();
            } catch (error) {
                console.error("Error saving vehicle:", error);
                alert("เกิดข้อผิดพลาดในการบันทึกข้อมูลทะเบียนรถ: " + error.message);
            }
        };

        const handleAddNewPayout = () => {
             const driversWithSavings = [...new Set(appState.fuelRecords
                .filter(r => (r.vehicleOwnership === 'company' || !r.vehicleOwnership) && r.driverName)
                .map(r => r.driverName))].sort((a,b) => a.localeCompare(b, 'th'));
            
            openModal('บันทึกการจ่ายเงินสะสม', renderSavingsPayoutFormContent(null, driversWithSavings));
            document.getElementById('savings-payout-form').addEventListener('submit', handleSavingsPayoutFormSubmit);
        }

        const handleEditPayout = (id) => {
            const payout = appState.savingsPayouts.find(p => p.id === id);
            if (!payout) return;
            const driversWithSavings = [...new Set(appState.fuelRecords
                .filter(r => (r.vehicleOwnership === 'company' || !r.vehicleOwnership) && r.driverName)
                .map(r => r.driverName))].sort((a,b) => a.localeCompare(b, 'th'));

            openModal('แก้ไขการจ่ายเงินสะสม', renderSavingsPayoutFormContent(payout, driversWithSavings));
            document.getElementById('savings-payout-form').addEventListener('submit', handleSavingsPayoutFormSubmit);
        };

        const handleDeletePayout = async (id) => {
            const payout = appState.savingsPayouts.find(p => p.id === id);
            if (!payout) return;
            
            if (confirm(`คุณต้องการลบรายการจ่ายเงินของ ${payout.driverName} จำนวน ${payout.payoutAmount} บาท ใช่หรือไม่?`)) {
                await logisticsService.deleteSavingsPayout(id);
                handleShowDriverSavingsDetails(payout.driverName);
            }
        };

        const handleSavingsPayoutFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const id = formData.get('id');
            const payoutData = {
                driverName: formData.get('driverName'),
                payoutDate: formData.get('payoutDate'),
                payoutAmount: Number(formData.get('payoutAmount')) || 0,
                notes: formData.get('notes'),
            };

            if (!payoutData.driverName || !payoutData.payoutDate || payoutData.payoutAmount <= 0) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง');
                return;
            }

            try {
                const promise = id 
                    ? logisticsService.updateSavingsPayout({ id, ...payoutData }) 
                    : logisticsService.addSavingsPayout(payoutData);
                await promise;
                closeModal();
                if (id) {
                    handleShowDriverSavingsDetails(payoutData.driverName);
                }
            } catch (error) {
                console.error("Error saving payout:", error);
                alert("เกิดข้อผิดพลาดในการบันทึก: " + error.message);
            }
        };
        
        const handleAddNewCarryOver = () => {
            const drivers = [...new Set(appState.fuelRecords
                .filter(r => (r.vehicleOwnership === 'company' || !r.vehicleOwnership) && r.driverName)
                .map(r => r.driverName))].sort((a,b) => a.localeCompare(b, 'th'));
            
            openModal('เพิ่มยอดยกมา / ปรับปรุงยอด', renderSavingsCarryOverFormContent(null, drivers));
            document.getElementById('savings-carryover-form').addEventListener('submit', handleSavingsCarryOverFormSubmit);
        };
        
        const handleEditCarryOver = (id) => {
            const carryOver = appState.savingsCarryOvers.find(c => c.id === id);
            if (!carryOver) return;
            const drivers = [...new Set(appState.fuelRecords
                .filter(r => (r.vehicleOwnership === 'company' || !r.vehicleOwnership) && r.driverName)
                .map(r => r.driverName))].sort((a,b) => a.localeCompare(b, 'th'));

            openModal('แก้ไขยอดยกมา / ปรับปรุงยอด', renderSavingsCarryOverFormContent(carryOver, drivers));
            document.getElementById('savings-carryover-form').addEventListener('submit', handleSavingsCarryOverFormSubmit);
        };

        const handleDeleteCarryOver = async (id) => {
            const carryOver = appState.savingsCarryOvers.find(c => c.id === id);
            if (!carryOver) return;
            
            if (confirm(`คุณต้องการลบรายการปรับปรุงยอดของ ${carryOver.driverName} จำนวน ${carryOver.carryOverAmount} บาท ใช่หรือไม่?`)) {
                await logisticsService.deleteSavingsCarryOver(id);
                handleShowDriverSavingsDetails(carryOver.driverName);
            }
        };

        const handleSavingsCarryOverFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const id = formData.get('id');
            const carryOverData = {
                driverName: formData.get('driverName'),
                carryOverDate: formData.get('carryOverDate'),
                carryOverAmount: Number(formData.get('carryOverAmount')) || 0,
                notes: formData.get('notes'),
            };

            if (!carryOverData.driverName || !carryOverData.carryOverDate || carryOverData.carryOverAmount <= 0) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง');
                return;
            }

            try {
                const promise = id 
                    ? logisticsService.updateSavingsCarryOver({ id, ...carryOverData }) 
                    : logisticsService.addSavingsCarryOver(carryOverData);
                await promise;
                closeModal();
                if (id) {
                    handleShowDriverSavingsDetails(carryOverData.driverName);
                }
            } catch (error) {
                console.error("Error saving carry-over:", error);
                alert("เกิดข้อผิดพลาดในการบันทึก: " + error.message);
            }
        };

        const handleShowDriverSavingsDetails = (driverName) => {
            openModal(`รายละเอียดเงินสะสม: ${driverName}`, renderDriverSavingsDetailsModalContent(driverName), 'max-w-5xl');
        };
        
        const renderSavingsPayoutFormContent = (payout, drivers) => {
            const driverOptions = drivers.map(name => `<option value="${name}" ${payout?.driverName === name ? 'selected' : ''}>${name}</option>`).join('');
            return `
                <form id="savings-payout-form" class="space-y-4">
                    <input type="hidden" name="id" value="${payout?.id || ''}" />
                    <div>
                        <label class="block text-base font-medium text-gray-400 mb-1">พนักงานขับรถ</label>
                        <select name="driverName" required class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="">-- เลือกพนักงานขับรถ --</option>
                            ${driverOptions}
                        </select>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">วันที่จ่าย</label>
                            <input type="date" name="payoutDate" value="${payout?.payoutDate || new Date().toISOString().split('T')[0]}" required class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                        </div>
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">จำนวนเงิน (บาท)</label>
                            <input type="number" name="payoutAmount" value="${payout?.payoutAmount || ''}" placeholder="0" required class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-base font-medium text-gray-400 mb-1">หมายเหตุ</label>
                        <textarea name="notes" placeholder="รายละเอียดเพิ่มเติม" rows="3" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white">${payout?.notes || ''}</textarea>
                    </div>
                    <footer class="flex justify-end gap-4 pt-4">
                        <button type="button" data-action="close-modal" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition">ยกเลิก</button>
                        <button type="submit" class="bg-primary hover:bg-secondary text-white font-bold py-2 px-6 rounded-lg transition">บันทึก</button>
                    </footer>
                </form>
            `;
        };
        
        const renderSavingsCarryOverFormContent = (carryOver, drivers) => {
            const driverOptions = drivers.map(name => `<option value="${name}" ${carryOver?.driverName === name ? 'selected' : ''}>${name}</option>`).join('');
            return `
                <form id="savings-carryover-form" class="space-y-4">
                    <input type="hidden" name="id" value="${carryOver?.id || ''}" />
                    <div>
                        <label class="block text-base font-medium text-gray-400 mb-1">พนักงานขับรถ</label>
                        <select name="driverName" required class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-accent">
                            <option value="">-- เลือกพนักงานขับรถ --</option>
                            ${driverOptions}
                        </select>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">วันที่</label>
                            <input type="date" name="carryOverDate" value="${carryOver?.carryOverDate || new Date().toISOString().split('T')[0]}" required class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                        </div>
                        <div>
                            <label class="block text-base font-medium text-gray-400 mb-1">จำนวนเงิน (บาท)</label>
                            <input type="number" name="carryOverAmount" value="${carryOver?.carryOverAmount || ''}" placeholder="0" required class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-base font-medium text-gray-400 mb-1">หมายเหตุ</label>
                        <textarea name="notes" placeholder="เช่น ยอดยกมาจากระบบเก่า" rows="3" class="w-full bg-slate-800 border border-slate-600 rounded-md shadow-sm px-3 py-2 text-white">${carryOver?.notes || ''}</textarea>
                    </div>
                    <footer class="flex justify-end gap-4 pt-4">
                        <button type="button" data-action="close-modal" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition">ยกเลิก</button>
                        <button type="submit" class="bg-success hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition">บันทึก</button>
                    </footer>
                </form>
            `;
        };

        const renderDriverSavingsDetailsModalContent = (driverName) => {
            const trips = appState.fuelRecords
                .filter(r => r.driverName === driverName && (r.vehicleOwnership === 'company' || !r.vehicleOwnership) && r.driverAllowance > 0)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const payouts = appState.savingsPayouts
                .filter(p => p.driverName === driverName)
                .sort((a, b) => new Date(b.payoutDate) - new Date(a.payoutDate));
                
            const carryOvers = appState.savingsCarryOvers
                .filter(c => c.driverName === driverName)
                .sort((a, b) => new Date(b.carryOverDate) - new Date(a.carryOverDate));

            const tripRows = trips.map(trip => `
                <tr class="border-b border-slate-700">
                    <td class="p-2">${trip.date}</td>
                    <td class="p-2 font-mono">${trip.vehicleRegistration}</td>
                    <td class="p-2">${trip.origin} → ${trip.destination}</td>
                    <td class="p-2 text-right">${(trip.driverAllowance || 0).toLocaleString()}</td>
                    <td class="p-2 text-right font-semibold text-info">200</td>
                </tr>`).join('');
                
            const carryOverRows = carryOvers.map(co => `
                <tr class="border-b border-slate-700">
                    <td class="p-2">${co.carryOverDate}</td>
                    <td class="p-2 text-right text-green-400">${(co.carryOverAmount || 0).toLocaleString()}</td>
                    <td class="p-2">${co.notes || ''}</td>
                    <td class="p-2 text-center">
                        <div class="flex justify-center gap-2">
                            <button data-action="edit-carryover" data-id="${co.id}" class="text-blue-400 hover:text-blue-300 p-1 rounded-full">${ICONS.Pencil}</button>
                            <button data-action="delete-carryover" data-id="${co.id}" class="text-red-500 hover:text-red-400 p-1 rounded-full">${ICONS.Trash}</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            const payoutRows = payouts.map(payout => `
                 <tr class="border-b border-slate-700">
                    <td class="p-2">${payout.payoutDate}</td>
                    <td class="p-2 text-right text-yellow-400">${(payout.payoutAmount || 0).toLocaleString()}</td>
                    <td class="p-2">${payout.notes || ''}</td>
                    <td class="p-2 text-center">
                        <div class="flex justify-center gap-2">
                            <button data-action="edit-payout" data-id="${payout.id}" class="text-blue-400 hover:text-blue-300 p-1 rounded-full">${ICONS.Pencil}</button>
                            <button data-action="delete-payout" data-id="${payout.id}" class="text-red-500 hover:text-red-400 p-1 rounded-full">${ICONS.Trash}</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-bold text-white mb-2">รายการสะสม (จากเบี้ยขับ)</h3>
                        <div class="max-h-96 overflow-y-auto bg-slate-800/50 rounded-lg p-2">
                            <table class="w-full text-base">
                                <thead class="sticky top-0 bg-slate-800"><tr>
                                    <th class="p-2 text-left">วันที่</th><th class="p-2 text-left">ทะเบียน</th>
                                    <th class="p-2 text-left">เส้นทาง</th><th class="p-2 text-right">เบี้ยขับเต็ม</th>
                                    <th class="p-2 text-right">เงินสะสม</th>
                                </tr></thead>
                                <tbody>${tripRows || `<tr><td colspan="5" class="text-center p-4 text-gray-500">ไม่มีรายการ</td></tr>`}</tbody>
                            </table>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-xl font-bold text-white mb-2">รายการยอดยกมา / ปรับปรุง</h3>
                             <div class="max-h-40 overflow-y-auto bg-slate-800/50 rounded-lg p-2">
                                <table class="w-full text-base">
                                    <thead class="sticky top-0 bg-slate-800"><tr>
                                        <th class="p-2 text-left">วันที่</th><th class="p-2 text-right">จำนวนเงิน</th>
                                        <th class="p-2 text-left">หมายเหตุ</th><th class="p-2 text-center">จัดการ</th>
                                    </tr></thead>
                                    <tbody>${carryOverRows || `<tr><td colspan="4" class="text-center p-4 text-gray-500">ไม่มีรายการ</td></tr>`}</tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white mb-2">ประวัติการจ่ายเงิน</h3>
                             <div class="max-h-40 overflow-y-auto bg-slate-800/50 rounded-lg p-2">
                                <table class="w-full text-base">
                                    <thead class="sticky top-0 bg-slate-800"><tr>
                                        <th class="p-2 text-left">วันที่จ่าย</th><th class="p-2 text-right">จำนวนเงิน</th>
                                        <th class="p-2 text-left">หมายเหตุ</th><th class="p-2 text-center">จัดการ</th>
                                    </tr></thead>
                                    <tbody>${payoutRows || `<tr><td colspan="4" class="text-center p-4 text-gray-500">ไม่มีรายการ</td></tr>`}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        const autoSizeColumns = (worksheet, data) => {
            if (!data || data.length === 0) return;
            const cols = Object.keys(data[0]);
            const colWidths = cols.map(col => ({
                wch: Math.max(...data.map(row => (row[col]?.toString() || '').length), col.length) + 2
            }));
            worksheet["!cols"] = colWidths;
        };

        const handleExportToExcel = () => {
            const filteredRecords = getFilteredFuelRecords();

            if (filteredRecords.length === 0) {
                alert("ไม่มีข้อมูลสำหรับส่งออก");
                return;
            }
            
            const workbook = XLSX.utils.book_new();
            const today = new Date().toISOString().split('T')[0];

            const stationKeys = logisticsService.getAllGasStationKeys();
            const friendlyNames = logisticsService.getAllGasStationFriendlyNames();

            // 1. Main Summary Sheet
            const mainSheetData = filteredRecords.map(record => {
                const queueDisplay = record.queueType && record.queueType !== 'none'
                    ? `${record.queueType === 'loading' ? 'คิวขาขึ้น' : 'คิวถ่าย'}: ${record.queueDetails || ''}`
                    : '';

                const row = {
                    'วันที่': record.date,
                    'ทะเบียนรถ': record.vehicleRegistration,
                    'ทะเบียนหาง': record.trailerRegistration || '',
                    'ชื่อพนักงานขับรถ': record.driverName || '',
                    'ประเภทรถ': record.vehicleType,
                    'สังกัด': record.vehicleOwnership === 'subcontractor' ? 'รถร่วม' : 'รถบริษัท',
                    'บริษัทขนส่ง': record.transportCompany || '',
                    'ต้นทาง': record.origin,
                    'ปลายทาง': record.destination,
                    'คิว': queueDisplay,
                    'ระยะทาง (กม.)': record.kilometers || '',
                    'เวลาเดินทาง (ชม.)': record.travelTime ? minutesToHoursAndMinutes(record.travelTime) : '',
                    'ปริมาณเชื้อเพลิง': record.fuelType === 'ngv' ? 'NGV' : (record.totalLiters || ''),
                    'ค่าเชื้อเพลิง (บาท)': record.totalBaht || '',
                    'ค่าขนส่ง (บาท)': record.shippingCost || '',
                    'เบี้ยขับ (บาท)': record.driverAllowance || '',
                    'รายละเอียด': record.details || '',
                    'หมายเหตุ': record.notes || ''
                };
                
                stationKeys.forEach(key => {
                    const name = friendlyNames[key] || key;
                    row[`${name} (ลิตร)`] = record.fuelDistributionLiters?.[key] || '';
                    row[`${name} (บาท)`] = record.fuelDistributionBaht?.[key] || '';
                });

                return row;
            });
            
            if (mainSheetData.length > 0) {
                const mainWorksheet = XLSX.utils.json_to_sheet(mainSheetData);
                autoSizeColumns(mainWorksheet, mainSheetData);
                XLSX.utils.book_append_sheet(workbook, mainWorksheet, "สรุปข้อมูลรวม");
            }

            // 2. Gas Station Sheets
            stationKeys.forEach(key => {
                const friendlyName = friendlyNames[key] || key;
                const stationRecords = filteredRecords.filter(record => 
                    (record.fuelDistributionLiters?.[key] > 0) || (record.fuelDistributionBaht?.[key] > 0)
                );

                if (stationRecords.length > 0) {
                    const stationSheetData = stationRecords.map(record => ({
                        'วันที่': record.date,
                        'ทะเบียนรถ': record.vehicleRegistration,
                        'เส้นทาง': `${record.origin} → ${record.destination}`,
                        'ปริมาณ (ลิตร)': record.fuelDistributionLiters?.[key] || '',
                        'ค่าใช้จ่าย (บาท)': record.fuelDistributionBaht?.[key] || ''
                    }));
                    
                    const stationWorksheet = XLSX.utils.json_to_sheet(stationSheetData);
                    autoSizeColumns(stationWorksheet, stationSheetData);
                    XLSX.utils.book_append_sheet(workbook, stationWorksheet, friendlyName.substring(0, 31)); 
                }
            });

            // 3. Driver Allowance Sheet
            const allowanceRecords = filteredRecords.filter(r => r.driverAllowance && r.driverAllowance > 0);
            if (allowanceRecords.length > 0) {
                const allowanceSheetData = allowanceRecords.map(record => ({
                    'วันที่': record.date,
                    'ทะเบียนรถ': record.vehicleRegistration,
                    'ชื่อพนักงานขับรถ': record.driverName || '',
                    'ประเภทรถ': record.vehicleType,
                    'เส้นทาง': `${record.origin} → ${record.destination}`,
                    'เบี้ยขับ (บาท)': record.driverAllowance
                }));

                const allowanceWorksheet = XLSX.utils.json_to_sheet(allowanceSheetData);
                autoSizeColumns(allowanceWorksheet, allowanceSheetData);
                XLSX.utils.book_append_sheet(workbook, allowanceWorksheet, "สรุปเบี้ยขับ");
            }

            // 4. Subcontractor Sheet
            const subcontractorRecords = filteredRecords.filter(r => r.vehicleOwnership === 'subcontractor');
            if (subcontractorRecords.length > 0) {
                const subcontractorSheetData = subcontractorRecords.map(record => ({
                    'วันที่': record.date,
                    'ทะเบียนรถ': record.vehicleRegistration,
                    'ประเภทรถ': record.vehicleType,
                    'ชื่อบริษัท': record.transportCompany || '',
                    'ชื่อพนักงานขับรถ': record.driverName || '',
                    'เส้นทาง': `${record.origin} → ${record.destination}`,
                    'ค่าขนส่ง (บาท)': record.shippingCost || ''
                }));

                const subcontractorWorksheet = XLSX.utils.json_to_sheet(subcontractorSheetData);
                autoSizeColumns(subcontractorWorksheet, subcontractorSheetData);
                XLSX.utils.book_append_sheet(workbook, subcontractorWorksheet, "รายงานรถร่วมขนส่ง");
            }

            // 5. NGV Sheet
            const ngvRecords = filteredRecords.filter(r => r.fuelType === 'ngv');
            if (ngvRecords.length > 0) {
                const ngvSheetData = ngvRecords.map(record => ({
                    'วันที่': record.date,
                    'ทะเบียน': record.vehicleRegistration,
                    'ชื่อพนักงานขับรถ': record.driverName || '',
                    'ประเภทรถ': record.vehicleType,
                    'เส้นทาง': `${record.origin} → ${record.destination}`,
                    'ค่าก๊าซ NGV (บาท)': record.totalBaht || ''
                }));
                const ngvWorksheet = XLSX.utils.json_to_sheet(ngvSheetData);
                autoSizeColumns(ngvWorksheet, ngvSheetData);
                XLSX.utils.book_append_sheet(workbook, ngvWorksheet, "รายงาน NGV");
            }
            
            XLSX.writeFile(workbook, `Fuel_Report_${today}.xlsx`);
        };
        
        const handleExportQueueReportsToExcel = () => {
            const loadingRecords = getFilteredQueueRecords('loading');
            const unloadingRecords = getFilteredQueueRecords('unloading');
            
            if (loadingRecords.length === 0 && unloadingRecords.length === 0) {
                alert("ไม่มีข้อมูลสำหรับส่งออก");
                return;
            }

            const workbook = XLSX.utils.book_new();
            const today = new Date().toISOString().split('T')[0];

            const mapRecordToSheetRow = (record) => ({
                'วันที่': record.date,
                'ทะเบียน': record.vehicleRegistration,
                'ทะเบียนหาง': record.trailerRegistration || '',
                'คนขับ': record.driverName || '',
                'ประเภทรถ (สังกัด)': `${record.vehicleType} (${record.vehicleOwnership === 'subcontractor' ? 'รถร่วม' : 'รถบริษัท'})`,
                'บริษัทขนส่ง': record.transportCompany || '',
                'เส้นทาง': `${record.origin} → ${record.destination}`,
                'ปริมาณเชื้อเพลิง': record.fuelType === 'ngv' ? 'NGV' : (record.totalLiters || ''),
                'ค่าเชื้อเพลิง (บาท)': record.totalBaht || '',
                'ค่าขนส่ง (บาท)': record.shippingCost || '',
                'เบี้ยขับ (บาท)': record.driverAllowance || '',
                'ระยะทาง (กม.)': record.kilometers || '',
                'เวลา (ชม.)': record.travelTime ? minutesToHoursAndMinutes(record.travelTime) : '',
                'รายละเอียด': record.details || '',
                'หมายเหตุ': record.notes || '',
                'ประเภทเชื้อเพลิง': record.fuelType === 'ngv' ? 'NGV' : 'Diesel'
            });

            if (loadingRecords.length > 0) {
                const sheetData = loadingRecords.map(mapRecordToSheetRow);
                const worksheet = XLSX.utils.json_to_sheet(sheetData);
                autoSizeColumns(worksheet, sheetData);
                XLSX.utils.book_append_sheet(workbook, worksheet, "รายงานคิวขาขึ้น");
            }

            if (unloadingRecords.length > 0) {
                const sheetData = unloadingRecords.map(mapRecordToSheetRow);
                const worksheet = XLSX.utils.json_to_sheet(sheetData);
                autoSizeColumns(worksheet, sheetData);
                XLSX.utils.book_append_sheet(workbook, worksheet, "รายงานคิวถ่าย");
            }

            XLSX.writeFile(workbook, `Queue_Report_${today}.xlsx`);
        };

        const handleExportSavingsToExcel = () => {
            const savingsData = getDriverSavingsData();

            if (savingsData.length === 0) {
                alert("ไม่มีข้อมูลเงินสะสมสำหรับส่งออก");
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const workbook = XLSX.utils.book_new();
            
            // Main Summary Sheet
            const summarySheetData = savingsData.map(driver => ({
                'ชื่อพนักงานขับรถ': driver.driverName,
                'จำนวนเที่ยว': driver.trips,
                'เบี้ยขับเต็ม (บาท)': driver.totalFullAllowance,
                'ยอดรวมเงินสะสม (บาท)': driver.totalSaved,
                'ยอดจ่ายแล้ว (บาท)': driver.totalPaid,
                'ยอดคงเหลือ (บาท)': driver.netBalance,
            }));

            const summaryWorksheet = XLSX.utils.json_to_sheet(summarySheetData);
            autoSizeColumns(summaryWorksheet, summarySheetData);
            XLSX.utils.book_append_sheet(workbook, summaryWorksheet, "สรุปเงินสะสม");

            // Detail sheets for each driver
            savingsData.forEach(driver => {
                const driverName = driver.driverName;
                const trips = appState.fuelRecords
                    .filter(r => r.driverName === driverName && (r.vehicleOwnership === 'company' || !r.vehicleOwnership) && r.driverAllowance > 0)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                const payouts = appState.savingsPayouts
                    .filter(p => p.driverName === driverName)
                    .sort((a, b) => new Date(a.payoutDate) - new Date(b.payoutDate));
                    
                const carryOvers = appState.savingsCarryOvers
                    .filter(c => c.driverName === driverName)
                    .sort((a, b) => new Date(a.carryOverDate) - new Date(b.carryOverDate));

                const combinedData = [];

                trips.forEach(t => {
                    combinedData.push({
                        'วันที่': t.date,
                        'รายการ': `เที่ยววิ่ง: ${t.origin} → ${t.destination}`,
                        'สะสม (บาท)': 200,
                        'จ่าย (บาท)': '',
                        'หมายเหตุ': `ทะเบียน ${t.vehicleRegistration}`
                    });
                });

                carryOvers.forEach(co => {
                    combinedData.push({
                        'วันที่': co.carryOverDate,
                        'รายการ': 'ยอดยกมา / ปรับปรุง',
                        'สะสม (บาท)': co.carryOverAmount,
                        'จ่าย (บาท)': '',
                        'หมายเหตุ': co.notes || ''
                    });
                });

                payouts.forEach(p => {
                    combinedData.push({
                        'วันที่': p.payoutDate,
                        'รายการ': 'จ่ายเงินสะสม',
                        'สะสม (บาท)': '',
                        'จ่าย (บาท)': p.payoutAmount,
                        'หมายเหตุ': p.notes || ''
                    });
                });

                if (combinedData.length > 0) {
                    const sortedCombinedData = combinedData.sort((a, b) => new Date(a['วันที่']) - new Date(b['วันที่']));
                    
                    let balance = 0;
                    const detailSheetData = sortedCombinedData.map(row => {
                         const saved = Number(row['สะสม (บาท)']) || 0;
                         const paid = Number(row['จ่าย (บาท)']) || 0;
                         balance += saved - paid;
                         return { ...row, 'คงเหลือ (บาท)': balance };
                    });

                    // Add a totals row at the end
                    const totalSaved = detailSheetData.reduce((sum, row) => sum + (Number(row['สะสม (บาท)']) || 0), 0);
                    const totalPaid = detailSheetData.reduce((sum, row) => sum + (Number(row['จ่าย (บาท)']) || 0), 0);
                    detailSheetData.push({}); // spacer
                    detailSheetData.push({
                        'วันที่': '',
                        'รายการ': 'ยอดรวม',
                        'สะสม (บาท)': totalSaved,
                        'จ่าย (บาท)': totalPaid,
                        'หมายเหตุ': 'ยอดคงเหลือสุทธิ',
                        'คงเหลือ (บาท)': balance
                    });

                    const detailWorksheet = XLSX.utils.json_to_sheet(detailSheetData);
                    autoSizeColumns(detailWorksheet, detailSheetData);
                    const safeSheetName = driverName.replace(/[\\/*?:"<>|]/g, '').substring(0, 31);
                    XLSX.utils.book_append_sheet(workbook, detailWorksheet, safeSheetName);
                }
            });

            XLSX.writeFile(workbook, `Driver_Savings_Report_${today}.xlsx`);
        };
        
        const handleExportRoutesToExcel = () => {
            // Get filtered and sorted data (same logic as updateRoutesTableBody)
            let routes = logisticsService.getRoutes();

            const activeFilters = Object.entries(appState.routeFilters).filter(([, value]) => value);
            if (activeFilters.length > 0) {
                routes = routes.filter(route => {
                    return activeFilters.every(([key, filterValue]) => {
                        const routeValue = route[key];
                        if (filterValue === null || filterValue === '') return true;
                        if (key === 'travelTime') {
                             return (minutesToHoursAndMinutes(routeValue) || '').includes(filterValue);
                        }
                        return (routeValue?.toString().toLowerCase() || '').includes(filterValue.toLowerCase());
                    });
                });
            }

            const { key: sortKey, direction: sortDirection } = appState.routeSort;
            if (sortKey) {
                const isNumeric = ['driverAllowance', 'kilometers', 'travelTime', 'totalLiters', 'totalBaht', 'shippingCost'].includes(sortKey);
                routes.sort((a, b) => {
                    let valA = a[sortKey] || (isNumeric ? 0 : '');
                    let valB = b[sortKey] || (isNumeric ? 0 : '');
                    if (sortKey === 'origin') {
                        valA = `${a.origin} ${a.destination}`;
                        valB = `${b.origin} ${b.destination}`;
                    }
                    let comparison = 0;
                    if (isNumeric) {
                        comparison = valA - valB;
                    } else {
                        comparison = (valA.toString()).localeCompare(valB.toString(), 'th');
                    }
                    return sortDirection === 'asc' ? comparison : -comparison;
                });
            }

            if (routes.length === 0) {
                alert("ไม่มีข้อมูลเส้นทางสำหรับส่งออก");
                return;
            }

            // Format data for Excel sheet
            const stationKeys = logisticsService.getAllGasStationKeys();
            const friendlyNames = logisticsService.getAllGasStationFriendlyNames();

            const sheetData = routes.map(route => {
                const row = {
                    'ประเภทรถ': route.vehicleType || '',
                    'ต้นทาง': route.origin || '',
                    'ปลายทาง': route.destination || '',
                    'บริษัทขนส่ง': route.transportCompany || '',
                    'คิวขาขึ้น': route.loadingQueue || '',
                    'คิวถ่าย': route.unloadingQueue || '',
                    'ระยะทาง (กม.)': route.kilometers || '',
                    'เวลาเดินทาง (ชม.)': route.travelTime ? minutesToHoursAndMinutes(route.travelTime) : '',
                    'เบี้ยขับ (บาท)': route.driverAllowance || '',
                    'ค่าขนส่ง (บาท)': route.shippingCost || '',
                    'รวมน้ำมัน (ลิตร)': route.totalLiters || '',
                    'รวมน้ำมัน (บาท)': route.totalBaht || '',
                };

                stationKeys.forEach(key => {
                    const name = friendlyNames[key] || key;
                    row[`${name} (ลิตร)`] = route.gasStationsLiters?.[key] || '';
                    row[`${name} (บาท)`] = route.gasStationsBaht?.[key] || '';
                });

                return row;
            });

            // Generate and download the Excel file
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.json_to_sheet(sheetData);
            autoSizeColumns(worksheet, sheetData);
            XLSX.utils.book_append_sheet(workbook, worksheet, "ข้อมูลเส้นทาง");

            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(workbook, `Routes_Data_${today}.xlsx`);
        };

        // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        // 6. INITIALIZATION
        // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        document.addEventListener('DOMContentLoaded', logisticsService.initialize);
        // --- END OF SCRIPT ---
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>